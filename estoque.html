<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estoque - Curral Burguer Gestão</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@10..48,700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #FFF9F3; }
    .font-heading { font-family: 'Bricolage Grotesque', sans-serif; }
    #main-content { flex: 1 1 auto; }
    .product-history-link { cursor: pointer; text-decoration: underline; color: #1E40AF; }
    .product-history-link:hover { color: #1D4ED8; }
  </style>
</head>
<body>

  <div class="flex flex-col md:flex-row min-h-screen">
    <!-- O app.js irá renderizar o menu lateral aqui -->
    <div id="sidebar-container"></div>
    
    <!-- Wrapper para main content e footer -->
    <div class="flex-1 flex flex-col">
      <main id="main-content" class="flex-1 p-4 md:p-8 bg-gray-50"></main>
      <!-- O app.js irá renderizar o rodapé aqui -->
      <div id="footer-container"></div>
    </div>
  </div>
  
  <div id="error-container" class="fixed top-4 right-4 z-50"></div>

  <script type="module">
    import { 
      checkAuth, 
      renderSidebarNav, 
      renderFooter, 
      renderScreenHeader,
      renderLoading,
      showError,
      getAppData,
      saveAppData,
      COLORS
    } from './app.js';

    // Estado local da página
    const pageState = {
      filterLowStock: true,
      loading: false
    };

    const mainContent = document.getElementById('main-content');

    // Função Principal de Renderização da Tela
    const renderEstoqueScreen = () => {
      const appData = getAppData();
      if (!appData) {
        showError("Falha ao carregar dados. Tentando novamente...");
        checkAuth(); // Deve redirecionar se tudo falhar
        return;
      }
      
      const { products } = appData;
      
      const buttonsHtml = `
        <button id="filter-stock-btn"
          class="px-4 py-2 rounded-md text-sm font-medium"
          style="background-color: ${pageState.filterLowStock ? COLORS.orange : COLORS.azure};
                 color: ${pageState.filterLowStock ? 'white' : COLORS.black};"
        >
          ${pageState.filterLowStock ? 'Mostrar Todos' : 'Filtrar Estoque Baixo'}
        </button>
      `;

      const filteredProducts = products.filter(p => {
        const isLow = p.property_estoque_atual < p.property_estoque_m_nimo;
        return !pageState.filterLowStock || (pageState.filterLowStock && isLow);
      });

      mainContent.innerHTML = `
        ${renderScreenHeader('Estoque', 'Produtos com estoque baixo ou zerado.', buttonsHtml)}
        
        <div class="overflow-x-auto bg-white rounded-lg shadow">
          <table class="min-w-full divide-y divide-gray-200">
            <thead style="background-color: ${COLORS.azure};">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Produto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Estoque Atual</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Estoque Mínimo</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ações</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${filteredProducts.map(product => {
                const isLow = product.property_estoque_atual < product.property_estoque_m_nimo;
                return `
                  <tr key="${product.id}" class="${isLow ? 'bg-red-50' : ''}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                      <a 
                        href="estoque_detalhe.html?id=${product.id}"
                        class="product-history-link font-medium"
                      >
                        ${product.property_nome}
                      </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${isLow ? 'font-bold text-red-600' : 'text-gray-600'}">${product.property_estoque_atual}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${product.property_estoque_m_nimo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      ${isLow ? `
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                          Abaixo do Mínimo
                        </span>
                      ` : `
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" style="background-color: ${COLORS.azure}; color: ${COLORS.blue};">
                          OK
                        </span>
                      `}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <button data-product-id="${product.id}" class="cotar-btn px-3 py-1 rounded-md text-xs font-medium text-white disabled:opacity-50"
                        style="background-color: ${COLORS.orange};" ${pageState.loading ? 'disabled' : ''}>
                        Cotar
                      </button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      // Adiciona eventos
      document.getElementById('filter-stock-btn')?.addEventListener('click', handleFilterStock);
      document.querySelectorAll('.cotar-btn').forEach(btn => btn.addEventListener('click', handleCreateQuote));
    };

    // --- Handlers ---

    const handleFilterStock = () => {
      pageState.filterLowStock = !pageState.filterLowStock;
      renderEstoqueScreen();
    };

    // RN-001: Criar Cotação
    const handleCreateQuote = (e) => {
      pageState.loading = true;
      renderEstoqueScreen(); // Re-renderiza para desabilitar botões
      
      const productId = e.currentTarget.dataset.productId;
      const appData = getAppData();
      const { products, productSuppliers, quotes, quoteItems } = appData;

      const product = products.find(p => p.id === productId);
      if (!product) {
        showError('Produto não encontrado.');
        pageState.loading = false;
        renderEstoqueScreen();
        return;
      }

      const productSupplierIds = product.property_fornecedor_do_produto;
      const supplierIds = productSuppliers
        .filter(ps => productSupplierIds.includes(ps.id))
        .map(ps => ps.property_fornecedor[0]);
      const uniqueSupplierIds = [...new Set(supplierIds)];

      if (uniqueSupplierIds.length === 0) {
        showError('Produto sem fornecedores cadastrados.');
        pageState.loading = false;
        renderEstoqueScreen();
        return;
      }
      
      const newQuoteId = `cot-id-${Math.random().toString(36).substr(2, 9)}`;
      const newQuoteName = `COT-${String(quotes.length + 1).padStart(3, '0')}`;
      const newQuote = {
        id: newQuoteId, name: newQuoteName, property_produto: [productId],
        property_quantidade: 1, property_unidade_de_medida: [product.property_unidade_de_medida],
        property_item: [], property_status: "Rascunho", property_nome: newQuoteName
      };
      
      const newItems = uniqueSupplierIds.map((supplierId, index) => {
        const newItemId = `item-id-${Math.random().toString(36).substr(2, 9)}`;
        newQuote.property_item.push(newItemId);
        return {
          id: newItemId, name: `${String(index + 1).padStart(3, '0')}`,
          property_status: "Criado", property_fornecedor: [supplierId],
          property_cota_o: [newQuoteId], property_produto: [productId],
          property_nome: `${String(index + 1).padStart(3, '0')}`, property_preco: null
        };
      });

      // Salva os novos dados no localStorage
      appData.quotes.push(newQuote);
      appData.quoteItems.push(...newItems);
      saveAppData(appData);

      console.log('Nova Cotação Criada:', newQuote);
      
      // Redireciona para a tela de detalhe da nova cotação
      window.location.href = `cotacao_detalhe.html?id=${newQuoteId}`;
    };

    // --- Inicialização ---
    document.addEventListener('DOMContentLoaded', () => {
      if (checkAuth()) {
        renderSidebarNav('estoque');
        renderFooter();
        renderLoading(mainContent, 'Carregando estoque...');
        // Simula um pequeno delay para garantir que os dados estejam disponíveis
        setTimeout(renderEstoqueScreen, 100); 
      }
    });

  </script>
</body>
</html>