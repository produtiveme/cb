<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estoque - Curral Burguer Gestão</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@10..48,700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #FFF9F3; }
    .font-heading { font-family: 'Bricolage Grotesque', sans-serif; }
    #main-content { flex: 1 1 auto; }
    .product-history-link { cursor: pointer; text-decoration: underline; color: #1E40AF; }
    .product-history-link:hover { color: #1D4ED8; }
  </style>
</head>
<body>

  <div class="flex flex-col md:flex-row min-h-screen">
    <!-- O app.js irá renderizar o menu lateral aqui -->
    <div id="sidebar-container"></div>
    
    <!-- Wrapper para main content e footer -->
    <div class="flex-1 flex flex-col">
      <main id="main-content" class="flex-1 p-4 md:p-8 bg-gray-50"></main>
      <!-- O app.js irá renderizar o rodapé aqui -->
      <div id="footer-container"></div>
    </div>
  </div>
  
  <div id="error-container" class="fixed top-4 right-4 z-50"></div>

  <script type="module">
    import { 
      checkAuth, 
      renderSidebarNav, 
      renderFooter, 
      renderScreenHeader,
      renderLoading,
      showError,
      getAppData,
      saveAppData,
      COLORS
    } from './app.js';

    // Estado local da página (agora com filtros)
    const pageState = {
      filters: {
        name: '',
        status: 'Todos',
        category: 'Todas',
        lowStock: true,
      },
      loading: false,
      availableCategories: [] // Cache das categorias
    };

    const mainContent = document.getElementById('main-content');
    
    // Extrai categorias únicas para o dropdown
    const getUniqueCategories = (products) => {
      const allCategories = products.flatMap(p => p.property_categoria || []);
      return [...new Set(allCategories)];
    };

    // ** MODIFICADO: Renderiza o card de filtros no container dele **
    const renderFilterCard = () => {
      const container = document.getElementById('filter-container');
      if (!container) return;

      const { name, status, category, lowStock } = pageState.filters;
      
      const categoryOptions = pageState.availableCategories.map(cat => 
        `<option value="${cat}" ${category === cat ? 'selected' : ''}>${cat}</option>`
      ).join('');

      // ** CORREÇÃO 2: Grid modificado para md:grid-cols-5 **
      container.innerHTML = `
        <div class="mb-4 p-4 bg-white rounded-lg shadow">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <!-- Filtro de Nome -->
            <div class="md:col-span-2">
              <label for="filter-name" class="block text-sm font-medium text-gray-700">Filtrar por nome</label>
              <input type="text" id="filter-name" value="${name}"
                class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
                style="--tw-ring-color: ${COLORS.orange};"
                placeholder="Digite o nome do produto..."
              />
            </div>
            
            <!-- Filtro de Situação -->
            <div>
              <label for="filter-status" class="block text-sm font-medium text-gray-700">Situação</label>
              <select id="filter-status"
                class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
                style="--tw-ring-color: ${COLORS.orange};">
                <option value="Todos" ${status === 'Todos' ? 'selected' : ''}>Todos</option>
                <option value="Ativo" ${status === 'Ativo' ? 'selected' : ''}>Ativo</option>
                <option value="Inativo" ${status === 'Inativo' ? 'selected' : ''}>Inativo</option>
              </select>
            </div>
            
            <!-- Filtro de Categoria -->
            <div>
              <label for="filter-category" class="block text-sm font-medium text-gray-700">Categoria</label>
              <select id="filter-category"
                class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
                style="--tw-ring-color: ${COLORS.orange};">
                <option value="Todas" ${category === 'Todas' ? 'selected' : ''}>Todas</option>
                ${categoryOptions}
              </select>
            </div>
            
            <!-- Botão de Estoque Baixo (agora alinhado) -->
            <div class="flex items-center justify-start md:justify-end">
              <button id="filter-stock-btn"
                class="w-full md:w-auto px-4 py-2 rounded-md text-sm font-medium"
                style="background-color: ${lowStock ? COLORS.orange : COLORS.azure};
                       color: ${lowStock ? 'white' : COLORS.black};"
              >
                ${lowStock ? 'Estoque Baixo' : 'Mostrar Todos'}
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Adiciona eventos aqui, depois de renderizar
      document.getElementById('filter-stock-btn')?.addEventListener('click', handleFilterStock);
      document.getElementById('filter-name')?.addEventListener('input', handleFilterChange);
      document.getElementById('filter-status')?.addEventListener('change', handleFilterChange);
      document.getElementById('filter-category')?.addEventListener('change', handleFilterChange);
    };

    // ** NOVO: Função separada para renderizar apenas a tabela **
    const renderEstoqueTable = () => {
      const container = document.getElementById('table-container');
      if (!container) return;

      const appData = getAppData();
      if (!appData) {
        showError("Falha ao carregar dados.");
        return;
      }
      const { products } = appData;
      const { name, status, category, lowStock } = pageState.filters;

      const filteredProducts = products.filter(p => {
        const isLow = p.property_estoque_atual < p.property_estoque_m_nimo;
        if (lowStock && !isLow) return false;
        if (name && !p.property_nome.toLowerCase().includes(name.toLowerCase())) return false;
        if (status !== 'Todos' && p.property_situa_o_do_produto !== status) return false;
        if (category !== 'Todas' && (!p.property_categoria || !p.property_categoria.includes(category))) return false;
        return true;
      });

      container.innerHTML = `
        <div class="overflow-x-auto bg-white rounded-lg shadow">
          <table class="min-w-full divide-y divide-gray-200">
            <thead style="background-color: ${COLORS.azure};">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Produto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Situação</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Estoque Atual</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ações</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${filteredProducts.length > 0 ? filteredProducts.map(product => {
                const isLow = product.property_estoque_atual < product.property_estoque_m_nimo;
                const situacao = product.property_situa_o_do_produto || 'Indefinida';
                return `
                  <tr key="${product.id}" class="${isLow ? 'bg-red-50' : ''}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                      <a 
                        href="estoque_detalhe.html?id=${product.id}"
                        class="product-history-link font-medium"
                      >
                        ${product.property_nome}
                      </a>
                      <p class="text-xs text-gray-500">${product.property_categoria ? product.property_categoria.join(', ') : ''}</p>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${situacao}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${isLow ? 'font-bold text-red-600' : 'text-gray-600'}">${product.property_estoque_atual}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      ${isLow ? `
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                          Abaixo do Mínimo
                        </span>
                      ` : `
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" style="background-color: ${COLORS.azure}; color: ${COLORS.blue};">
                          OK
                        </span>
                      `}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <button data-product-id="${product.id}" class="cotar-btn px-3 py-1 rounded-md text-xs font-medium text-white disabled:opacity-50"
                        style="background-color: ${COLORS.orange};" ${pageState.loading ? 'disabled' : ''}>
                        Cotar
                      </button>
                    </td>
                  </tr>
                `;
              }).join('') : `
                <tr>
                  <td colspan="5" class="px-6 py-4 text-center text-gray-500">Nenhum produto encontrado com esses filtros.</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>
      `;

      // Adiciona eventos da tabela
      document.querySelectorAll('.cotar-btn').forEach(btn => btn.addEventListener('click', handleCreateQuote));
    };


    // Função Principal de Renderização da Tela (MODIFICADA)
    // ** CORREÇÃO 1: Esta função agora só renderiza a estrutura e chama as funções filhas **
    const renderEstoqueScreen = () => {
      const appData = getAppData();
      if (!appData) {
        showError("Falha ao carregar dados. Tentando novamente...");
        checkAuth(); 
        return;
      }
      
      // Popula as categorias se for a primeira vez
      if (pageState.availableCategories.length === 0) {
        pageState.availableCategories = getUniqueCategories(appData.products);
      }
      
      // Renderiza a estrutura principal
      mainContent.innerHTML = `
        ${renderScreenHeader('Estoque', 'Filtre e gerencie produtos em estoque.')}
        
        <!-- Container para os filtros (não será recarregado) -->
        <div id="filter-container"></div>
        
        <!-- Container para a tabela (será recarregado) -->
        <div id="table-container"></div>
      `;
      
      // Chama as funções para preencher a estrutura
      renderFilterCard();
      renderEstoqueTable();
    };

    // --- Handlers ---
    
    // ** CORREÇÃO 1: Handlers de filtro agora só chamam renderEstoqueTable() **
    const handleFilterChange = (e) => {
      const { id, value } = e.target;
      if (id === 'filter-name') pageState.filters.name = value;
      if (id === 'filter-status') pageState.filters.status = value;
      if (id === 'filter-category') pageState.filters.category = value;
      
      renderEstoqueTable(); // Re-renderiza APENAS a tabela
    };

    const handleFilterStock = () => {
      pageState.filters.lowStock = !pageState.filters.lowStock;
      // Atualiza o botão sem recarregar tudo
      const btn = document.getElementById('filter-stock-btn');
      if (btn) {
        btn.textContent = pageState.filters.lowStock ? 'Estoque Baixo' : 'Mostrar Todos';
        btn.style.backgroundColor = pageState.filters.lowStock ? COLORS.orange : COLORS.azure;
        btn.style.color = pageState.filters.lowStock ? 'white' : COLORS.black;
      }
      renderEstoqueTable(); // Re-renderiza APENAS a tabela
    };

    // Criar Cotação (Modificado para chamar renderEstoqueTable)
    const handleCreateQuote = (e) => {
      pageState.loading = true;
      renderEstoqueTable(); // Re-renderiza a tabela para desabilitar botões
      
      const productId = e.currentTarget.dataset.productId;
      const appData = getAppData();
      const { products, productSuppliers, quotes, quoteItems } = appData;

      const product = products.find(p => p.id === productId);
      if (!product) {
        showError('Produto não encontrado.');
        pageState.loading = false;
        renderEstoqueTable();
        return;
      }

      const productSupplierIds = product.property_fornecedor_do_produto;
      const supplierIds = productSuppliers
        .filter(ps => productSupplierIds.includes(ps.id))
        .map(ps => ps.property_fornecedor[0]);
      const uniqueSupplierIds = [...new Set(supplierIds)];

      if (uniqueSupplierIds.length === 0) {
        showError('Produto sem fornecedores cadastrados.');
        pageState.loading = false;
        renderEstoqueTable();
        return;
      }
      
      const newQuoteId = `cot-id-${Math.random().toString(36).substr(2, 9)}`;
      const newQuoteName = `COT-${String(quotes.length + 1).padStart(3, '0')}`;
      const newQuote = {
        id: newQuoteId, name: newQuoteName, property_produto: [productId],
        property_quantidade: 1, property_unidade_de_medida: [product.property_unidade_de_medida],
        property_item: [], property_status: "Rascunho", property_nome: newQuoteName
      };
      
      const newItems = uniqueSupplierIds.map((supplierId, index) => {
        const newItemId = `item-id-${Math.random().toString(36).substr(2, 9)}`;
        newQuote.property_item.push(newItemId);
        return {
          id: newItemId, name: `${String(index + 1).padStart(3, '0')}`,
          property_status: "Criado", property_fornecedor: [supplierId],
          property_cota_o: [newQuoteId], property_produto: [productId],
          property_nome: `${String(index + 1).padStart(3, '0')}`, property_preco: null
        };
      });

      appData.quotes.push(newQuote);
      appData.quoteItems.push(...newItems);
      saveAppData(appData);

      window.location.href = `cotacao_detalhe.html?id=${newQuoteId}`;
    };

    // --- Inicialização ---
    document.addEventListener('DOMContentLoaded', () => {
      if (checkAuth()) {
        renderSidebarNav('estoque');
        renderFooter();
        renderLoading(mainContent, 'Carregando estoque...');
        setTimeout(renderEstoqueScreen, 100); 
      }
    });

  </script>
</body>
</html>