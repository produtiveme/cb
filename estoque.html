<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estoque - Curral Burguer Gestão</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@10..48,700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #FFF9F3; }
    .font-heading { font-family: 'Bricolage Grotesque', sans-serif; }
    #main-content { flex: 1 1 auto; }
    .product-history-link { cursor: pointer; text-decoration: underline; color: #1E40AF; }
    .product-history-link:hover { color: #1D4ED8; }
  </style>
</head>
<body>

  <div class="flex flex-col md:flex-row min-h-screen">
    <!-- O app.js irá renderizar o menu lateral aqui -->
    <div id="sidebar-container"></div>
    
    <!-- Wrapper para main content e footer -->
    <div class="flex-1 flex flex-col">
      <main id="main-content" class="flex-1 p-4 md:p-8 bg-gray-50"></main>
      <!-- O app.js irá renderizar o rodapé aqui -->
      <div id="footer-container"></div>
    </div>
  </div>
  
  <div id="error-container" class="fixed top-4 right-4 z-50"></div>
  <!-- O Modal de Confirmação será injetado aqui pelo app.js -->

  <script type="module">
    import { 
      checkAuth, 
      renderSidebarNav, 
      renderFooter, 
      renderScreenHeader,
      renderLoading,
      showError,
      // ** NOVO: Importando o modal **
      showConfirmationModal,
      getAppData,
      saveAppData,
      COLORS
    } from './app.js';

    // Estado local da página
    const pageState = {
      loading: false,
      filters: {
        name: '',
        status: 'Todos',
        category: 'Todas',
        lowStockOnly: false
      },
      availableCategories: []
    };

    const mainContent = document.getElementById('main-content');

    // Helper para extrair categorias únicas
    const getUniqueCategories = (products) => {
      const allCategories = products.flatMap(p => p.property_categoria || []);
      return [...new Set(allCategories)];
    };

    // ** MODIFICADO: Função separada para renderizar apenas os filtros **
    const renderFilterCard = () => {
      const container = document.getElementById('filter-container');
      if (!container) return;

      const { name, status, category, lowStockOnly } = pageState.filters;
      
      const categoryOptions = pageState.availableCategories.map(cat => 
        `<option value="${cat}" ${category === cat ? 'selected' : ''}>${cat}</option>`
      ).join('');

      // Definindo a classe do botão de Estoque Baixo
      const lowStockButtonClass = lowStockOnly
        ? `w-full px-3 py-2 mt-1 text-sm font-medium text-white rounded-md shadow-sm border border-transparent`
        : `w-full px-3 py-2 mt-1 text-sm font-medium rounded-md shadow-sm border border-gray-300 bg-white text-gray-700 hover:bg-gray-50`;
      
      const lowStockButtonStyle = lowStockOnly ? `background-color: ${COLORS.orange};` : '';


      container.innerHTML = `
        <div class="mb-4 p-4 bg-white rounded-lg shadow">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            
            <!-- Filtro de Nome -->
            <div class="md:col-span-2">
              <label for="filter-name" class="block text-sm font-medium text-gray-700">Filtrar por nome</label>
              <input type="text" id="filter-name" value="${name}"
                class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
                style="--tw-ring-color: ${COLORS.orange};"
                placeholder="Digite o nome do produto..."
              />
            </div>
            
            <!-- Filtro de Situação -->
            <div>
              <label for="filter-status" class="block text-sm font-medium text-gray-700">Situação</label>
              <select id="filter-status"
                class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
                style="--tw-ring-color: ${COLORS.orange};">
                <option value="Todos" ${status === 'Todos' ? 'selected' : ''}>Todos</option>
                <option value="Ativo" ${status === 'Ativo' ? 'selected' : ''}>Ativo</option>
                <option value="Inativo" ${status === 'Inativo' ? 'selected' : ''}>Inativo</option>
              </select>
            </div>
            
            <!-- Filtro de Categoria -->
            <div>
              <label for="filter-category" class="block text-sm font-medium text-gray-700">Categoria</label>
              <select id="filter-category"
                class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
                style="--tw-ring-color: ${COLORS.orange};">
                <option value="Todas" ${category === 'Todas' ? 'selected' : ''}>Todas</Filtro>
                ${categoryOptions}
              </select>
            </div>

            <!-- Botão de Estoque Baixo -->
            <div>
              <label class="block text-sm font-medium text-transparent hidden md:block">&nbsp;</label>
              <button id="filter-low-stock"
                class="${lowStockButtonClass}"
                style="${lowStockButtonStyle}">
                Estoque Baixo
              </button>
            </div>

          </div>
        </div>
      `;
      
      // Adiciona eventos (apenas nos filtros)
      document.getElementById('filter-name')?.addEventListener('input', handleFilterChange);
      document.getElementById('filter-status')?.addEventListener('change', handleFilterChange);
      document.getElementById('filter-category')?.addEventListener('change', handleFilterChange);
      document.getElementById('filter-low-stock')?.addEventListener('click', handleFilterChange);
    };

    // ** NOVO: Função separada para renderizar apenas a tabela **
    const renderEstoqueTable = () => {
      const container = document.getElementById('table-container');
      if (!container) return;

      const appData = getAppData();
      if (!appData) return;
      
      const { products } = appData;
      const { name, status, category, lowStockOnly } = pageState.filters;

      // Lógica de filtragem
      const filteredProducts = products.filter(p => {
        if (name && !p.property_nome.toLowerCase().includes(name.toLowerCase())) return false;
        if (status !== 'Todos' && p.property_situa_o_do_produto !== status) return false;
        if (category !== 'Todas' && (!p.property_categoria || !p.property_categoria.includes(category))) return false;
        if (lowStockOnly && !p.property_alerta_de_estoque) return false;
        return true;
      });

      // HTML da Tabela
      container.innerHTML = `
        <div class="overflow-x-auto bg-white rounded-lg shadow">
          <table class="min-w-full divide-y divide-gray-200">
            <thead style="background-color: ${COLORS.azure};">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Produto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Situação</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Estoque Atual</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Estoque Mínimo</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ações</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${filteredProducts.length > 0 ? filteredProducts.map(product => {
                const estoqueAtual = product.property_estoque_atual || 0;
                const estoqueMinimo = product.property_estoque_m_nimo || 0;
                const alerta = product.property_alerta_de_estoque;
                
                const situacao = product.property_situa_o_do_produto || 'Indefinida';
                
                let estoqueClass = 'text-gray-600';
                if (alerta) estoqueClass = 'text-red-600 font-bold';
                
                return `
                  <tr key="${product.id}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                      <a 
                        href="estoque_detalhe.html?id=${product.id}"
                        class="product-history-link font-medium"
                        title="Ver histórico e detalhes do produto"
                      >
                        ${product.property_nome}
                      </a>
                      <p class="text-xs text-gray-500">${product.property_categoria ? product.property_categoria.join(', ') : ''}</p>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${situacao}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${estoqueClass}">${estoqueAtual}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${estoqueMinimo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <button data-product-id="${product.id}" class="cotar-btn px-3 py-1 rounded-md text-xs font-medium text-white disabled:opacity-50"
                        style="background-color: ${COLORS.orange};" ${pageState.loading ? 'disabled' : ''}>
                        Cotar
                      </button>
                    </td>
                  </tr>
                `;
              }).join('') : `
                <tr>
                  <td colspan="5" class="px-6 py-4 text-center text-gray-500">Nenhum produto encontrado com esses filtros.</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>
      `;

      // Adiciona eventos da tabela
      document.querySelectorAll('.cotar-btn').forEach(btn => btn.addEventListener('click', handleCreateQuote));
    };


    // Função Principal de Renderização da Tela (MODIFICADA)
    const renderEstoqueScreen = () => {
      const appData = getAppData();
      if (!appData) {
        showError("Falha ao carregar dados. Tentando novamente...");
        checkAuth(); // Volta ao login se os dados não existirem
        return;
      }
      
      // Popula as categorias na primeira renderização
      if (pageState.availableCategories.length === 0) {
        pageState.availableCategories = getUniqueCategories(appData.products);
      }
      
      // Define o HTML base da tela
      mainContent.innerHTML = `
        ${renderScreenHeader('Controlo de Estoque', 'Acompanhe os níveis de estoque e crie cotações.')}
        <div id="filter-container"></div>
        <div id="table-container"></div>
      `;
      
      // Renderiza os componentes separados
      renderFilterCard();
      renderEstoqueTable();
    };


    // --- Handlers ---
    
    // Handler unificado para filtros
    const handleFilterChange = (e) => {
      const { id, value } = e.currentTarget;
      
      if (id === 'filter-name') pageState.filters.name = value;
      if (id === 'filter-status') pageState.filters.status = value;
      if (id === 'filter-category') pageState.filters.category = value;
      if (id === 'filter-low-stock') {
        pageState.filters.lowStockOnly = !pageState.filters.lowStockOnly;
        // Re-renderiza o card de filtros para atualizar o estilo do botão
        renderFilterCard(); 
      }
      
      // Re-renderiza APENAS a tabela
      renderEstoqueTable(); 
    };

    // ** MODIFICADO: Lógica de Criar Cotação agora usa o Modal **
    const handleCreateQuote = (e) => {
      // 1. Apenas busca os dados, não ativa o "loading" ainda
      const productId = e.currentTarget.dataset.productId;
      const appData = getAppData();
      const { products, productSuppliers, quotes, quoteItems } = appData;

      const product = products.find(p => p.id === productId);
      if (!product) {
        showError('Produto não encontrado.');
        return;
      }

      // 2. Conta os fornecedores
      const productSupplierIds = product.property_fornecedor_do_produto;
      const supplierIds = productSuppliers
        .filter(ps => productSupplierIds.includes(ps.id))
        .map(ps => ps.property_fornecedor[0]);
      const uniqueSupplierIds = [...new Set(supplierIds)];

      // 3. Regra 3: Validação de zero fornecedores
      if (uniqueSupplierIds.length === 0) {
        showError('Produto sem fornecedores cadastrados. Cotação não pode ser criada.');
        return;
      }
      
      // 4. Regra 2: Constrói a mensagem dinâmica
      const messageHtml = `
        <p>Tem certeza que quer gerar uma nova cotação para o produto <strong>${product.property_nome}</strong>?</p>
        <p class="mt-2">O estoque atual é de <strong>${product.property_estoque_atual}</strong>.</p>
        <p class="mt-2">A cotação será criada para <strong>${uniqueSupplierIds.length}</strong> fornecedor(es).</p>
      `;
      
      // 5. Regra 1: Chama o Modal de Confirmação
      showConfirmationModal('Confirmar Criação de Cotação', messageHtml, () => {
        // --- Esta é a lógica que só executa no "Confirmar" ---
        
        pageState.loading = true;
        renderEstoqueTable(); // Re-renderiza a tabela para desabilitar botões

        const newQuoteId = `cot-id-${Math.random().toString(36).substr(2, 9)}`;
        const newQuoteName = `COT-${String(quotes.length + 1).padStart(3, '0')}`;
        const newQuote = {
          id: newQuoteId, name: newQuoteName, property_produto: [productId],
          property_quantidade: 1, property_unidade_de_medida: [product.property_unidade_de_medida],
          property_item: [], property_status: "Rascunho", property_nome: newQuoteName
        };
        
        const newItems = uniqueSupplierIds.map((supplierId, index) => {
          const newItemId = `item-id-${Math.random().toString(36).substr(2, 9)}`;
          newQuote.property_item.push(newItemId);
          return {
            id: newItemId, name: `${String(index + 1).padStart(3, '0')}`,
            property_status: "Criado", property_fornecedor: [supplierId],
            property_cota_o: [newQuoteId], property_produto: [productId],
            property_nome: `${String(index + 1).padStart(3, '0')}`, property_preco: null
          };
        });

        appData.quotes.push(newQuote);
        appData.quoteItems.push(...newItems);
        saveAppData(appData);

        window.location.href = `cotacao_detalhe.html?id=${newQuoteId}`;
        // --- Fim da lógica de confirmação ---
      });
    };

    // --- Inicialização ---
    document.addEventListener('DOMContentLoaded', () => {
      if (checkAuth()) {
        renderSidebarNav('estoque');
        renderFooter();
        renderLoading(mainContent, 'Carregando estoque...');
        // Usamos um pequeno timeout para garantir que os dados do localStorage estejam prontos
        setTimeout(renderEstoqueScreen, 100); 
      }
    });

  </script>
</body>
</html>