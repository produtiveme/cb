<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estoque - Gestão de Cotação</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Estilo Global Centralizado -->
  <link rel="stylesheet" href="style.css">

</head>

<body>

  <div class="flex flex-col md:flex-row min-h-screen">

    <!-- Sidebar (será preenchida pelo app.js) -->
    <div id="sidebar-container"></div>

    <!-- Conteúdo Principal -->
    <main class="flex-1 p-6 md:p-10">

      <!-- Cabeçalho (será preenchido pelo app.js) -->
      <header id="header-container"></header>

      <!-- Container para Alertas -->
      <div id="error-container" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>

      <!-- Container do Modal (inicialmente oculto) -->
      <div id="modal-container" class="hidden"></div>

      <!-- Card de Filtros (será preenchido pelo JS) -->
      <div id="filters-container" class="mb-6"></div>

      <!-- Tabela de Produtos (será preenchida pelo JS) -->
      <div id="stock-table-container">
        <!-- O Spinner de carregamento ou a tabela serão injetados aqui -->
      </div>

    </main>
  </div>

  <!-- Rodapé (será preenchido pelo app.js) -->
  <div id="footer-container"></div>


  <!-- Script da Página -->
  <script type="module">
    import {
      checkAuth,
      getAppData,
      saveAppData,
      getProductById,
      renderSidebarNav,
      renderFooter,
      renderLoading,
      renderScreenHeader,
      showError,
      showFeedback,
      showConfirmationModal,
      N8N_URLS,
      postApi
    } from './app.js';

    // --- Estado da Página ---
    const pageState = {
      appData: null,
      filters: {
        name: '',
        category: 'all',
        status: 'all',
        stockLow: false,
      },
      categories: [], // Lista de categorias únicas
    };

    // --- Funções Principais ---

    /**
     * Inicializa a página
     */
    function init() {
      // 1. Verifica autenticação
      if (!checkAuth()) return;

      // 2. Carrega dados do localStorage
      pageState.appData = getAppData();
      if (!pageState.appData) {
        showError("Falha ao carregar dados. Tente fazer login novamente.");
        return;
      }

      // 3. Prepara dados auxiliares
      pageState.categories = extractCategories(pageState.appData.products);

      // 4. Renderiza componentes estáticos
      renderSidebarNav('estoque'); // Marca 'Estoque' como ativo
      renderFooter();
      renderScreenHeader("Controlo de Estoque", "Visualize e filtre os produtos.");

      // 5. Renderiza componentes dinâmicos (filtros e tabela)
      renderFilters();
      renderStockTable();

      // 6. Adiciona listeners de eventos (só depois que os filtros existirem)
      addEventListeners();
    }

    /**
     * Extrai categorias únicas da lista de produtos
     */
    function extractCategories(products) {
      const allCategories = new Set();
      products.forEach(p => {
        if (p.property_categoria && Array.isArray(p.property_categoria)) {
          p.property_categoria.forEach(cat => allCategories.add(cat));
        }
      });
      return Array.from(allCategories).sort();
    }

    /**
     * Renderiza o card de filtros
     */
    function renderFilters() {
      const container = document.getElementById('filters-container');
      if (!container) return;

      const categoryOptions = pageState.categories
        .map(cat => `<option value="${cat}">${cat}</option>`)
        .join('');

      container.innerHTML = `
        <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            
            <!-- Filtro Nome -->
            <div class="md:col-span-2">
              <label for="filter-name" class="block text-sm font-medium text-gray-700">Filtrar por nome</label>
              <input 
                type="text" 
                id="filter-name" 
                value="${pageState.filters.name}"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
                style="--tw-ring-color: #FF4E00;"
                placeholder="Ex: Batata Frita"
              >
            </div>

            <!-- Filtro Categoria -->
            <div>
              <label for="filter-category" class="block text-sm font-medium text-gray-700">Categoria</label>
              <select 
                id="filter-category" 
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
                style="--tw-ring-color: #FF4E00;"
              >
                <option value="all">Todas</option>
                ${categoryOptions}
              </select>
            </div>

            <!-- Filtro Situação -->
            <div>
              <label for="filter-status" class="block text-sm font-medium text-gray-700">Situação</label>
              <select 
                id="filter-status" 
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
                style="--tw-ring-color: #FF4E00;"
              >
                <option value="all">Todas</option>
                <option value="Ativo">Ativo</option>
                <option value="Inativo">Inativo</option>
              </select>
            </div>

            <!-- Botão Estoque Baixo -->
            <div class="md:col-span-1">
              <button 
                id="filter-stock-low"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium transition-colors"
                style="background-color: ${pageState.filters.stockLow ? '#FF4E00' : '#D4E7E6'}; color: ${pageState.filters.stockLow ? 'white' : '#1D1C1B'};"
              >
                Estoque Baixo
              </button>
            </div>

          </div>
        </div>
      `;

      // Define os valores selecionados nos dropdowns
      document.getElementById('filter-category').value = pageState.filters.category;
      document.getElementById('filter-status').value = pageState.filters.status;
    }

    /**
     * Adiciona os event listeners aos filtros
     */
    function addEventListeners() {
      document.getElementById('filter-name').addEventListener('input', (e) => {
        pageState.filters.name = e.target.value;
        renderStockTable(); // Apenas renderiza a tabela, não os filtros
      });

      document.getElementById('filter-category').addEventListener('change', (e) => {
        pageState.filters.category = e.target.value;
        renderStockTable();
      });

      document.getElementById('filter-status').addEventListener('change', (e) => {
        pageState.filters.status = e.target.value;
        renderStockTable();
      });

      document.getElementById('filter-stock-low').addEventListener('click', () => {
        pageState.filters.stockLow = !pageState.filters.stockLow;
        renderFilters(); // Renderiza os filtros para atualizar a cor do botão
        renderStockTable(); // Renderiza a tabela
        addEventListeners(); // Re-adiciona os listeners
      });
    }

    /**
     * Aplica os filtros e renderiza a tabela de estoque
     */
    function renderStockTable() {
      const container = document.getElementById('stock-table-container');
      if (!container) return;

      renderLoading(container); // Mostra o spinner

      const { products } = pageState.appData;
      const { name, category, status, stockLow } = pageState.filters;

      // Aplica filtros
      const filteredProducts = products.filter(product => {
        const fName = name.toLowerCase();
        const pName = (product.property_nome || '').toLowerCase();

        const matchName = pName.includes(fName);

        const matchCategory = category === 'all' ||
          (product.property_categoria && product.property_categoria.includes(category));

        const matchStatus = status === 'all' ||
          (product.property_situa_o_do_produto === status);

        const matchStockLow = !stockLow ||
          (product.property_alerta_de_estoque === true); // property_alerta_de_estoque é o "Estoque Baixo"

        return matchName && matchCategory && matchStatus && matchStockLow;
      });

      // Simula um pequeno atraso para o spinner ser visível
      setTimeout(() => {
        if (filteredProducts.length === 0) {
          container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow border text-center text-gray-500">Nenhum produto encontrado com os filtros aplicados.</div>`;
          return;
        }

        // Constrói o HTML da Tabela
        container.innerHTML = `
          <div class="bg-white shadow-md rounded-lg border border-gray-200 overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estoque Atual</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estoque Mínimo</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unidade</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Situação</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${filteredProducts.map(product => renderRow(product)).join('')}
              </tbody>
            </table>
          </div>
        `;

        // Adiciona listeners aos botões "Cotar"
        document.querySelectorAll('.cotar-btn').forEach(btn => {
          btn.addEventListener('click', (e) => handleCreateQuote(e.target.dataset.id));
        });

      }, 100); // Atraso de 100ms
    }

    /**
     * Renderiza uma linha da tabela de estoque
     */
    function renderRow(product) {
      const estoqueAtual = product.property_estoque_atual || 0;
      const estoqueMinimo = product.property_estoque_m_nimo || 0;

      const isLowStock = product.property_alerta_de_estoque === true;

      // Define a cor do texto do estoque
      let stockColorClass = 'text-gray-900';
      if (isLowStock) {
        stockColorClass = 'text-red-600 font-bold'; // Vermelho e negrito
      }

      // Define o badge de situação
      const status = product.property_situa_o_do_produto || 'Indefinido';
      const statusColorClass = status === 'Ativo' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';

      return `
        <tr>
          <!-- Nome do Produto (Link) -->
          <td class="px-6 py-4 whitespace-nowrap">
            <a 
              href="estoque_detalhe.html?id=${product.id}" 
              class="text-sm font-medium hover:underline"
              style="color: #FF4E00;"
              title="Ver histórico e detalhes"
            >
              ${product.property_nome}
            </a>
          </td>
          
          <!-- Estoque Atual -->
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="text-sm ${stockColorClass}">
              ${estoqueAtual}
            </span>
          </td>
          
          <!-- Estoque Mínimo -->
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${estoqueMinimo}
          </td>
          
          <!-- Unidade -->
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${product.property_unidade_de_medida || 'N/A'}
          </td>
          
          <!-- Situação -->
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorClass}">
              ${status}
            </span>
          </td>
          
          <!-- Ações -->
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button
              class="cotar-btn px-3 py-1 rounded-md text-white transition-colors"
              style="background-color: #6B9E83;"
              data-id="${product.id}"
            >
              Cotar
            </button>
          </td>
        </tr>
      `;
    }

    /**
     * Lida com o clique no botão "Cotar"
     */
    async function handleCreateQuote(productId) {
      const { appData } = pageState;

      const product = getProductById(productId);
      if (!product) {
        showError("Produto não encontrado.");
        return;
      }

      // 0. Regra de Negócio: Cotação Única (RN-003)
      // Verifica se já existe uma cotação em aberto para este produto
      const openQuote = appData.quotes.find(q =>
        q.property_produto &&
        q.property_produto.includes(productId) &&
        !['Concluído', 'Finalizada'].includes(q.property_status)
      );

      if (openQuote) {
        showError(`Já existe uma cotação em aberto (${openQuote.property_nome}) para este produto. Finalize-a antes de criar uma nova.`);
        return;
      }

      // 1. Encontrar fornecedores para este produto
      const productSuppliers = appData.productSuppliers.filter(
        ps => ps.property_produto.includes(productId)
      );

      const supplierIds = productSuppliers.map(ps => ps.property_fornecedor[0]);
      const uniqueSupplierIds = [...new Set(supplierIds)];

      // 2. Regra de Negócio: Sem fornecedores
      if (uniqueSupplierIds.length === 0) {
        showError(`Produto "${product.property_nome}" não possui fornecedores cadastrados. Cotação não pode ser criada.`);
        return;
      }

      // 3. Regra de Negócio: Confirmação
      const estoqueAtual = product.property_estoque_atual || 0;
      const unidadeMedida = product.property_unidade_de_medida || 'Unidade';

      const messageHtml = `
        <p>Tem certeza que quer gerar uma nova cotação para o produto <strong>${product.property_nome}</strong>?</p>
        <p class="text-sm text-gray-500 mt-2">
          O estoque atual é de <strong>${estoqueAtual} ${unidadeMedida}</strong>.
          <br>
          A cotação será criada para <strong>${uniqueSupplierIds.length}</strong> fornecedor(es).
        </p>
        
        <!-- Input de Quantidade -->
        <div class="mt-4">
          <label for="quote-quantity" class="block text-sm font-medium text-gray-700">
            Quantidade a Cotar (em ${unidadeMedida})
          </label>
          <input 
            type="number" 
            id="quote-quantity" 
            value="1" 
            min="1"
            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
            style="--tw-ring-color: #FF4E00;"
            required
          >
          <p id="quote-quantity-error" class="hidden text-xs text-red-500 mt-1">A quantidade deve ser maior que 0.</p>
        </div>
      `;

      showConfirmationModal({
        title: "Confirmar Nova Cotação",
        messageHtml: messageHtml,
        confirmText: "Confirmar e Criar",
        cancelText: "Cancelar",
        asyncAction: async () => {
          // Esta função é executada quando o usuário clica em "Confirmar"

          // 4. Validar e obter a quantidade
          const quantityInput = document.getElementById('quote-quantity');
          const quantityError = document.getElementById('quote-quantity-error');
          const quantity = parseInt(quantityInput.value, 10);

          if (isNaN(quantity) || quantity <= 0) {
            quantityInput.classList.add('border-red-500'); // Adiciona borda vermelha
            if (quantityError) quantityError.classList.remove('hidden'); // Mostra erro
            // Lança um erro para impedir o modal de fechar
            throw new Error("A quantidade deve ser um número maior que zero.");
          }

          // Se a validação passar, remove o erro (caso exista)
          quantityInput.classList.remove('border-red-500');
          if (quantityError) quantityError.classList.add('hidden');

          // 5. Gerar a nova cotação e itens (localmente)
          const lastQuote = appData.quotes.length > 0 ?
            appData.quotes.reduce((a, b) => {
              const numA = parseInt(a.property_nome.split('-')[1]);
              const numB = parseInt(b.property_nome.split('-')[1]);
              return numA > numB ? a : b;
            }) : { property_nome: 'COT-0' };

          const lastQuoteNum = parseInt(lastQuote.property_nome.split('-')[1]);
          const newQuoteNum = (lastQuoteNum + 1).toString().padStart(3, '0');
          const newQuoteName = `COT-${newQuoteNum}`;

          const newQuoteId = crypto.randomUUID();

          const newQuote = {
            id: newQuoteId,
            property_nome: newQuoteName,
            property_status: "Rascunho",
            property_produto: [productId],
            property_quantidade: quantity, // Quantidade do input
            property_unidade_de_medida: [unidadeMedida], // Unidade de medida
            property_item: [], // Será preenchido abaixo
            url: "#" // URL local temporária
          };

          const newItems = [];

          let lastItemNum = appData.quoteItems.length > 0 ?
            appData.quoteItems.reduce((a, b) => {
              const numA = parseInt(a.property_nome);
              const numB = parseInt(b.property_nome);
              return (numA || 0) > (numB || 0) ? a : b;
            }) : { property_nome: '0' };

          let currentItemNum = parseInt(lastItemNum.property_nome || '0');

          for (const supplierId of uniqueSupplierIds) {
            currentItemNum++;
            const newItemId = crypto.randomUUID();
            const newItem = {
              id: newItemId,
              property_nome: currentItemNum.toString().padStart(3, '0'),
              property_status: "Criado",
              property_fornecedor: [supplierId],
              property_cota_o: [newQuoteId],
              property_preco: 0,
              url: "#"
            };

            newItems.push(newItem);
            newQuote.property_item.push(newItemId); // Liga o item à cotação
          }

          // 6. Preparar Payload para o N8N
          const payload = {
            cotacao: {
              property_nome: newQuote.property_nome,
              property_status: newQuote.property_status,
              property_produto: newQuote.property_produto,
              property_quantidade: newQuote.property_quantidade,
              property_unidade_de_medida: newQuote.property_unidade_de_medida,
              id_local: newQuote.id // Envia ID local
            },
            itens: newItems.map(item => ({
              property_nome: item.property_nome,
              property_status: item.property_status,
              property_fornecedor: item.property_fornecedor,
              property_preco: item.property_preco,
              id_local: item.id // Envia ID local
            }))
          };

          // 7. Enviar para o N8N (o modal mostrará o spinner)
          // A função postApi já está configurada para lançar erro
          await postApi(N8N_URLS.createQuote, payload);

          // 8. Se o N8N deu certo, salvar localmente
          appData.quotes.push(newQuote);
          appData.quoteItems.push(...newItems);
          saveAppData(appData);

          // 9. Feedback de sucesso e redirecionamento
          showFeedback("Cotação criada com sucesso!", "success");
          window.location.href = `cotacao_detalhe.html?id=${newQuoteId}`;
        }
      });
    }

    // --- Inicialização ---
    init(); // Inicia a página

  </script>

</body>

</html>