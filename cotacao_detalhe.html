<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhe da Cotação - Gestão de Cotação</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Estilo Global Centralizado -->
  <link rel="stylesheet" href="style.css">

</head>
<body>

  <div class="flex flex-col md:flex-row min-h-screen">
    
    <!-- Sidebar (será preenchida pelo app.js) -->
    <div id="sidebar-container"></div>

    <!-- Conteúdo Principal -->
    <main class="flex-1 p-6 md:p-10">

      <!-- Cabeçalho (será preenchido pelo app.js) -->
      <header id="header-container"></header>

      <!-- Container para Alertas -->
      <div id="error-container" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>
      
      <!-- Container do Modal (inicialmente oculto) -->
      <div id="modal-container" class="hidden"></div>

      <!-- Conteúdo da Página (será preenchido pelo JS) -->
      <div id="quote-detail-container">
        <!-- O Spinner de carregamento ou os detalhes da cotação serão injetados aqui -->
      </div>
      
    </main>
  </div>

  <!-- Rodapé (será preenchido pelo app.js) -->
  <div id="footer-container"></div>


  <!-- Script da Página -->
  <script type="module">
    import {
      checkAuth,
      getAppData,
      saveAppData,
      renderSidebarNav,
      renderFooter,
      renderLoading,
      renderScreenHeader,
      showError,
      showFeedback,
      getUrlParam,
      getQuoteById,
      getItemById,
      getProductName,
      getSupplierName,
      COLORS
    } from './app.js';

    // --- Estado da Página ---
    const pageState = {
      appData: null,
      quoteId: null,
      quote: null,
      quoteItems: []
    };

    // --- Funções Principais ---

    /**
     * Inicializa a página
     */
    function init() {
      // 1. Verifica autenticação
      if (!checkAuth()) return;

      // 2. Carrega dados do localStorage
      pageState.appData = getAppData();
      if (!pageState.appData) {
        showError("Falha ao carregar dados. Tente fazer login novamente.");
        return;
      }
      
      // 3. Pega o ID da cotação da URL
      pageState.quoteId = getUrlParam('id');
      if (!pageState.quoteId) {
        showError("ID da cotação não fornecido.");
        renderPageError("Cotação não encontrada.");
        return;
      }
      
      // 4. Encontra a cotação
      pageState.quote = getQuoteById(pageState.quoteId);
      if (!pageState.quote) {
        showError("Cotação não encontrada.");
        renderPageError(`Cotação com ID ${pageState.quoteId} não foi encontrada.`);
        return;
      }
      
      // 5. Encontra os itens desta cotação
      const itemIds = pageState.quote.property_item || [];
      pageState.quoteItems = itemIds.map(id => getItemById('quoteItems', id)).filter(Boolean); // Filtra nulos/undefined

      // 6. Renderiza componentes estáticos
      renderSidebarNav('cotacoes'); // Marca 'Cotações' como ativo
      renderFooter();
      
      // 7. Renderiza a tela de detalhes
      renderCotacaoDetailScreen();
    }
    
    /**
     * Renderiza o layout principal da tela de detalhes
     */
    function renderCotacaoDetailScreen() {
      const { quote, quoteItems } = pageState;
      const container = document.getElementById('quote-detail-container');
      if (!container) return;

      const productName = getProductName(quote.property_produto[0]);
      const status = quote.property_status || 'Indefinido';
      const quantidade = quote.property_quantidade || 'N/A';
      const unidade = (quote.property_unidade_de_medida && quote.property_unidade_de_medida[0]) || '';
      
      // Subtítulo do cabeçalho
      const subtitle = `Produto: ${productName} | Qtd: ${quantidade} ${unidade} | Status: ${status}`;
      
      // Renderiza Cabeçalho
      renderScreenHeader(
        `${quote.property_nome}`, 
        subtitle
      );
      
      // Renderiza Conteúdo
      container.innerHTML = `
        <div class="space-y-6">
          ${renderActionsCard()}
          ${renderItemsTable()}
        </div>
      `;
      
      // Adiciona listeners de eventos
      addEventListeners();
    }
    
    /**
     * Renderiza o card de Ações (WhatsApp)
     */
    function renderActionsCard() {
      // TODO: Adicionar botões de mudança de status (Aguardando, Finalizada)
      return `
        <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
          <h3 class="text-lg font-bold font-heading mb-4" style="color: ${COLORS.black};">Ações</h3>
          <button id="whatsapp-btn" class="px-4 py-2 text-white rounded-md font-medium transition" style="background-color: #25D366;">
            Gerar Texto WhatsApp
          </button>
        </div>
      `;
    }
    
    /**
     * Renderiza a tabela de Itens da Cotação
     */
    function renderItemsTable() {
      const { quoteItems } = pageState;
      
      if (quoteItems.length === 0) {
        return `
          <div class="bg-white p-6 rounded-lg shadow border text-center text-gray-500">
            Nenhum item encontrado para esta cotação.
          </div>
        `;
      }
      
      const tableRows = quoteItems.map(item => renderItemRow(item)).join('');
      
      return `
        <div class="bg-white shadow-md rounded-lg border border-gray-200 overflow-hidden">
          <h3 class="text-lg font-bold font-heading p-6" style="color: ${COLORS.black};">Itens da Cotação</h3>
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fornecedor</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço (R$)</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${tableRows}
            </tbody>
          </table>
        </div>
      `;
    }
    
    /**
     * Renderiza uma linha da tabela de itens
     */
    function renderItemRow(item) {
      const supplierName = getSupplierName(item.property_fornecedor[0]);
      const status = item.property_status || 'Criado';
      const preco = item.property_preco || 0;
      
      let statusColorClass = 'bg-gray-100 text-gray-800'; // Criado
      switch (status) {
        case 'Aprovado':
          statusColorClass = 'bg-green-100 text-green-800';
          break;
        case 'Rejeitado':
          statusColorClass = 'bg-red-100 text-red-800';
          break;
      }
      
      // Define a cor do texto do preço
      let precoColorClass = 'text-gray-900';
      if (preco > 0) {
        precoColorClass = 'text-blue-600 font-bold';
      }

      // Verifica se o item pode ser editado (baseado no status da cotação)
      const isRascunho = pageState.quote.property_status === 'Rascunho';
      
      return `
        <tr>
          <!-- Fornecedor -->
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${supplierName}</div>
            <div class="text-sm text-gray-500">${item.property_nome}</div>
          </td>
          
          <!-- Status -->
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorClass}">
              ${status}
            </span>
          </td>
          
          <!-- Preço -->
          <td class="px-6 py-4 whitespace-nowrap">
            <input 
              type="number" 
              class="preco-input text-sm ${precoColorClass} w-24 p-1 border rounded-md ${isRascunho ? 'border-gray-300' : 'border-transparent bg-transparent'}"
              value="${preco}"
              data-item-id="${item.id}"
              ${isRascunho ? '' : 'disabled'}
            >
          </td>
          
          <!-- Ações (Aprovar / Rejeitar) -->
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
            ${isRascunho ? `
              <button 
                class="aprovar-btn px-3 py-1 rounded-md text-white transition-colors"
                style="background-color: ${COLORS.blue};"
                data-item-id="${item.id}"
                title="Aprovar este item (rejeita os outros)"
              >
                Aprovar
              </button>
              <button 
                class="rejeitar-btn px-3 py-1 rounded-md bg-gray-200 text-gray-700 transition-colors hover:bg-gray-300"
                data-item-id="${item.id}"
                title="Rejeitar este item"
              >
                Rejeitar
              </button>
            ` : (status === 'Aprovado' ? '✔️ Aprovado' : '❌ Rejeitado')}
          </td>
        </tr>
      `;
    }
    
    /**
     * Renderiza uma mensagem de erro na página
     */
    function renderPageError(message) {
      renderScreenHeader("Erro", "", ""); // Limpa cabeçalho
      const container = document.getElementById('quote-detail-container');
      if (container) {
        container.innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow border border-red-200 text-center">
            <h3 class="text-lg font-bold text-red-600">Ocorreu um Erro</h3>
            <p class="mt-2 text-gray-600">${message}</p>
            <a 
              href="cotacoes.html" 
              class="mt-6 inline-block px-4 py-2 bg-gray-200 text-gray-800 rounded-md font-medium hover:bg-gray-300 transition text-sm"
            >
              &larr; Voltar para Cotações
            </a>
          </div>
        `;
      }
    }
    
    /**
     * Adiciona todos os event listeners da página
     */
    function addEventListeners() {
      // Botão WhatsApp
      document.getElementById('whatsapp-btn')?.addEventListener('click', handleWhatsappClick);
      
      // Inputs de Preço
      document.querySelectorAll('.preco-input').forEach(input => {
        input.addEventListener('change', handlePrecoChange);
      });
      
      // Botões de Ação dos Itens
      document.querySelectorAll('.aprovar-btn').forEach(btn => {
        btn.addEventListener('click', handleAprovarClick);
      });
      
      document.querySelectorAll('.rejeitar-btn').forEach(btn => {
        btn.addEventListener('click', handleRejeitarClick);
      });
    }
    
    // --- Lógica de Ações ---
    
    /**
     * Gera o texto para o WhatsApp e copia para a área de transferência
     */
    function getWhatsappText() {
      const { quote } = pageState;
      const productName = getProductName(quote.property_produto[0]);
      const quantidade = quote.property_quantidade || 'N/A';
      const unidade = (quote.property_unidade_de_medida && quote.property_unidade_de_medida[0]) || '';
      
      // Texto Genérico (RN-001-3)
      return `
        Olá, gostaria de cotar o seguinte item:
        Produto: ${productName}
        Quantidade: ${quantidade} ${unidade}
        
        Referência: ${quote.property_nome}
        
        Aguardo o seu retorno com o valor. Obrigado!
      `.trim().replace(/^\s+/gm, ''); // Remove espaços extras e indentação
    }
    
    function handleWhatsappClick() {
      const text = getWhatsappText();
      
      try {
        // Usa a API de Clipboard moderna
        navigator.clipboard.writeText(text).then(() => {
          showFeedback("Texto para WhatsApp copiado!", "success");
        }, (err) => {
          // Fallback para document.execCommand (necessário em alguns iframes)
          console.warn("Falha no navigator.clipboard, usando fallback:", err);
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed"; // Evita scroll
          textArea.style.opacity = 0;
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          try {
            document.execCommand('copy');
            showFeedback("Texto para WhatsApp copiado!", "success");
          } catch (errFallback) {
            console.error("Falha no fallback de cópia:", errFallback);
            showError("Falha ao copiar texto. Copie manualmente.");
          }
          document.body.removeChild(textArea);
        });
      } catch (err) {
        console.error("API de Clipboard não disponível:", err);
        showError("Falha ao copiar. API não disponível.");
      }
    }
    
    /**
     * Atualiza o preço de um item no localStorage
     */
    function handlePrecoChange(event) {
      const itemId = event.target.dataset.itemId;
      const novoPreco = parseFloat(event.target.value) || 0;
      
      // Encontra o item no estado da aplicação (appData)
      const itemIndex = pageState.appData.quoteItems.findIndex(i => i.id === itemId);
      if (itemIndex > -1) {
        pageState.appData.quoteItems[itemIndex].property_preco = novoPreco;
        saveAppData(pageState.appData); // Salva a alteração
        showFeedback("Preço atualizado.", "success");
      } else {
        showError("Erro ao salvar: Item não encontrado.");
      }
    }
    
    /**
     * Aprova um item (e rejeita os outros)
     */
    function handleAprovarClick(event) {
      const itemIdAprovado = event.target.dataset.itemId;
      
      pageState.quoteItems.forEach(item => {
        const itemIndex = pageState.appData.quoteItems.findIndex(i => i.id === item.id);
        if (itemIndex === -1) return;
        
        if (item.id === itemIdAprovado) {
          pageState.appData.quoteItems[itemIndex].property_status = "Aprovado";
        } else {
          pageState.appData.quoteItems[itemIndex].property_status = "Rejeitado";
        }
      });
      
      // Atualiza o status da Cotação principal
      const quoteIndex = pageState.appData.quotes.findIndex(q => q.id === pageState.quoteId);
      if (quoteIndex > -1) {
        pageState.appData.quotes[quoteIndex].property_status = "Aguardando";
      }
      
      // Salva tudo
      saveAppData(pageState.appData);
      
      // Re-renderiza a tela para mostrar as mudanças
      showFeedback("Item aprovado! A cotação mudou para 'Aguardando'.", "success");
      init(); // Recarrega os dados e renderiza a tela
    }
    
    /**
     * Rejeita um item específico
     */
    function handleRejeitarClick(event) {
      const itemIdRejeitado = event.target.dataset.itemId;
      
      const itemIndex = pageState.appData.quoteItems.findIndex(i => i.id === itemIdRejeitado);
      if (itemIndex > -1) {
        pageState.appData.quoteItems[itemIndex].property_status = "Rejeitado";
        saveAppData(pageState.appData);
        showFeedback("Item rejeitado.", "success");
        init(); // Recarrega e renderiza
      }
    }

    // --- Inicialização ---
    init(); // Inicia a página

  </script>

</body>
</html>