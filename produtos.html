<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produtos - Curral Burguer Gestão</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@10..48,700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #FFF9F3; }
    .font-heading { font-family: 'Bricolage Grotesque', sans-serif; }
    #main-content { flex: 1 1 auto; }
  </style>
</head>
<body>

  <div class="flex flex-col md:flex-row min-h-screen">
    <div id="sidebar-container"></div>
    <div class="flex-1 flex flex-col">
      <main id="main-content" class="flex-1 p-4 md:p-8 bg-gray-50"></main>
      <div id="footer-container"></div>
    </div>
  </div>
  <div id="error-container" class="fixed top-4 right-4 z-50"></div>
  <div id="modal-container" class="hidden"></div> <!-- Para o modal -->

  <script type="module">
    import { 
      checkAuth, 
      renderSidebarNav, 
      renderFooter, 
      renderScreenHeader,
      renderLoading,
      showError,
      showConfirmationModal, // Importa o modal
      getAppData,
      saveAppData,
      getSupplierName,
      COLORS
    } from './app.js';

    const mainContent = document.getElementById('main-content');

    // Estado local da página (para filtros)
    const pageState = {
      filters: {
        name: '',
        status: 'Todos',
        category: 'Todas'
      },
      categories: [],
      products: [],
      filteredProducts: []
    };

    // --- Lógica de Criação de Cotação ---
    const handleCreateQuote = (e) => {
      const productId = e.currentTarget.dataset.productId;
      const appData = getAppData();
      if (!appData) return;

      const { products, suppliers, productSuppliers } = appData;
      const product = products.find(p => p.id === productId);
      if (!product) {
        showError('Produto não encontrado.');
        return;
      }

      // Encontra fornecedores únicos para este produto
      const supplierIds = productSuppliers
        .filter(ps => ps.property_produto.includes(productId))
        .map(ps => ps.property_fornecedor[0]);
      const uniqueSupplierIds = [...new Set(supplierIds)];
      
      const supplierCount = uniqueSupplierIds.length;
      const unit = product.property_unidade_de_medida || 'Unidade';

      // 1. Validação (Regra 3)
      if (supplierCount === 0) {
        showError(`Produto ${product.property_nome} não tem fornecedores cadastrados. Cotação não pode ser criada.`);
        return;
      }

      // 2. Confirmação (Regras 1 e 2)
      // ** MODIFICADO: Adiciona input de quantidade **
      const messageHtml = `
        <p>Tem certeza que quer gerar uma nova cotação para o produto <strong>${product.property_nome}</strong>?</p>
        <p class="text-sm mt-2">O estoque atual é de <strong>${product.property_estoque_atual}</strong>.</p>
        <p class="text-sm">A cotação será criada para <strong>${supplierCount}</strong> fornecedor(es).</p>
        
        <div class="mt-4">
          <label for="quote-quantity" class="block text-sm font-medium text-gray-700">
            Quantidade a Cotar (em ${unit})
          </label>
          <input type="number" id="quote-quantity" value="1" min="1"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
            style="--tw-ring-color: ${COLORS.orange};"
            required
          >
        </div>
      `;

      showConfirmationModal("Confirmar Nova Cotação", messageHtml, () => {
        // ** MODIFICADO: Valida e lê a quantidade **
        const quantityInput = document.getElementById('quote-quantity');
        const quantity = parseFloat(quantityInput.value) || 0;

        if (quantity <= 0) {
          showError('A quantidade deve ser maior que zero.');
          // Mantém o modal aberto
          throw new Error("Validation failed"); // Impede o modal de fechar
        }

        // 3. Lógica de Criação
        const appData = getAppData(); // Pega os dados mais recentes
        const newQuoteId = `quote_${new Date().toISOString()}`;
        const newQuote = {
          id: newQuoteId,
          name: `COT-${appData.quotes.length + 1}`,
          url: '', // Será preenchido pelo N8N
          property_produto: [product.id],
          property_quantidade: quantity, // <-- ** NOVO **
          property_unidade_de_medida: [unit], // <-- ** NOVO **
          property_item: [],
          property_status: "Rascunho",
          property_nome: `COT-${appData.quotes.length + 1}`
        };

        const newItems = uniqueSupplierIds.map((supplierId, index) => {
          const newItemId = `item_${newQuoteId}_${index}`;
          newQuote.property_item.push(newItemId); // Vincula item à cotação
          return {
            id: newItemId,
            name: `${newQuote.name}-Item-${index + 1}`,
            url: '',
            property_status: 'Criado',
            property_fornecedor: [supplierId],
            property_cota_o: [newQuoteId],
            property_produto: [],
            property_nome: `${newQuote.name}-Item-${index + 1}`,
            property_preco: 0
          };
        });

        // Salva no localStorage
        appData.quotes.unshift(newQuote); // Adiciona no início
        appData.quoteItems.push(...newItems);
        saveAppData(appData);

        // Navega para a nova cotação
        window.location.href = `cotacao_detalhe.html?id=${newQuoteId}`;
      });
    };

    // --- Lógica de Renderização ---

    // Filtra os produtos com base no estado
    const applyFilters = () => {
      const { name, status, category } = pageState.filters;
      pageState.filteredProducts = pageState.products.filter(product => {
        const nameMatch = name === '' || product.property_nome.toLowerCase().includes(name.toLowerCase());
        const statusMatch = status === 'Todos' || product.property_situa_o_do_produto === status;
        const categoryMatch = category === 'Todas' || product.property_categoria.includes(category);
        return nameMatch && statusMatch && categoryMatch;
      });
      renderProdutosTable();
    };

    // Renderiza a tabela de produtos
    const renderProdutosTable = () => {
      const tableBody = document.getElementById('produtos-table-body');
      if (!tableBody) return;

      tableBody.innerHTML = pageState.filteredProducts.map(product => {
        return `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
              <a href="estoque_detalhe.html?id=${product.id}" 
                 class="product-detail-link"
                 style="color: ${COLORS.orange};"
                 title="Ver detalhes de ${product.property_nome}">
                ${product.property_nome}
              </a>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${product.property_unidade_de_medida || 'N/D'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${product.property_categoria[0] || 'N/D'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
              ${product.property_situa_o_do_produto || 'N/D'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex gap-2 justify-end">
              <a
                href="estoque_detalhe.html?id=${product.id}"
                class="px-3 py-1 rounded-md text-xs font-medium bg-gray-200 hover:bg-gray-300"
                title="Ver histórico de ${product.property_nome}"
              >
                Histórico
              </a>
              <button
                data-product-id="${product.id}"
                class="cotar-btn px-3 py-1 rounded-md text-white text-xs"
                style="background-color: ${COLORS.orange};"
                title="Criar cotação para ${product.property_nome}"
              >
                Cotar
              </button>
            </td>
          </tr>
        `;
      }).join('');

      // Reanexa eventos aos novos botões
      document.querySelectorAll('.cotar-btn').forEach(btn => btn.addEventListener('click', handleCreateQuote));
    };

    // Renderiza o card de filtros
    const renderFilterCard = () => {
      const filterContainer = document.getElementById('filter-container');
      if (!filterContainer) return;
      
      const { name, status, category } = pageState.filters;

      filterContainer.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          
          <!-- Filtro Nome -->
          <div>
            <label for="filter-name" class="block text-sm font-medium text-gray-700">Buscar por nome</label>
            <input
              type="text"
              id="filter-name"
              value="${name}"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
              style="--tw-ring-color: ${COLORS.orange};"
              placeholder="Ex: Batata Frita..."
            />
          </div>

          <!-- Filtro Situação -->
          <div>
            <label for="filter-status" class="block text-sm font-medium text-gray-700">Situação</label>
            <select
              id="filter-status"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
              style="--tw-ring-color: ${COLORS.orange};"
            >
              <option ${status === 'Todos' ? 'selected' : ''}>Todos</option>
              <option ${status === 'Ativo' ? 'selected' : ''}>Ativo</option>
              <option ${status === 'Inativo' ? 'selected' : ''}>Inativo</option>
            </select>
          </div>

          <!-- Filtro Categoria -->
          <div>
            <label for="filter-category" class="block text-sm font-medium text-gray-700">Categoria</label>
            <select
              id="filter-category"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
              style="--tw-ring-color: ${COLORS.orange};"
            >
              <option>Todas</option>
              ${pageState.categories.map(cat => 
                `<option ${category === cat ? 'selected' : ''}>${cat}</option>`
              ).join('')}
            </select>
          </div>
        </div>
      `;

      // Adiciona eventos aos filtros (apenas na renderização inicial)
      document.getElementById('filter-name').addEventListener('input', (e) => {
        pageState.filters.name = e.target.value;
        applyFilters();
      });
      document.getElementById('filter-status').addEventListener('change', (e) => {
        pageState.filters.status = e.target.value;
        applyFilters();
      });
      document.getElementById('filter-category').addEventListener('change', (e) => {
        pageState.filters.category = e.target.value;
        applyFilters();
      });
    };

    // Renderiza a tela principal de produtos
    const renderProdutosScreen = () => {
      const appData = getAppData();
      if (!appData) {
        showError("Falha ao carregar dados.");
        return;
      }
      
      // Carrega dados no estado local
      pageState.products = appData.products;
      const allCategories = appData.products.flatMap(p => p.property_categoria);
      pageState.categories = [...new Set(allCategories)].sort(); // Pega categorias únicas

      mainContent.innerHTML = `
        ${renderScreenHeader('Produtos', 'Visualize todos os produtos cadastrados.')}
        
        <!-- Card de Filtros -->
        <div id="filter-container" class="bg-white p-4 rounded-lg shadow mb-6">
          <!-- Conteúdo dos filtros será renderizado pelo JS -->
        </div>

        <!-- Tabela de Produtos -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead style="background-color: ${COLORS.azure};">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Nome do Produto</th>
                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Un. Medida</th>
                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Categoria</th>
                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Situação</th>
                <th class="px-6 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">Ações</th>
              </tr>
            </thead>
            <tbody id="produtos-table-body" class="bg-white divide-y divide-gray-200">
              <!-- Linhas da tabela serão renderizadas pelo JS -->
            </tbody>
          </table>
        </div>
      `;
      
      // Renderiza os filtros e a tabela inicial
      renderFilterCard();
      applyFilters(); 
    };

    // --- Inicialização ---
    document.addEventListener('DOMContentLoaded', () => {
      if (checkAuth()) {
        renderSidebarNav('produtos');
        renderFooter();
        renderLoading(mainContent, 'Carregando produtos...');
        // Oculta a mensagem de erro que pode ter ficado do login
        document.getElementById('error-container').innerHTML = ''; 
        setTimeout(renderProdutosScreen, 100); 
      }
    });
  </script>
</body>
</html>