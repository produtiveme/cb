<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produtos - Gestão de Cotação</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Estilo Global Centralizado -->
  <link rel="stylesheet" href="style.css">

</head>
<body>

  <div class="flex flex-col md:flex-row min-h-screen">
    
    <!-- Sidebar (será preenchida pelo app.js) -->
    <div id="sidebar-container"></div>

    <!-- Conteúdo Principal -->
    <main class="flex-1 p-6 md:p-10">

      <!-- Cabeçalho (será preenchido pelo app.js) -->
      <header id="header-container"></header>

      <!-- Container para Alertas -->
      <div id="error-container" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>
      
      <!-- Container do Modal (inicialmente oculto) -->
      <div id="modal-container" class="hidden"></div>

      <!-- Conteúdo da Página (será preenchido pelo JS) -->
      <div id="products-list-container">
        <!-- O Spinner de carregamento ou a lista de produtos serão injetados aqui -->
      </div>
      
    </main>
  </div>

  <!-- Rodapé (será preenchido pelo app.js) -->
  <div id="footer-container"></div>


  <!-- Script da Página -->
  <script type="module">
    import {
      checkAuth,
      getAppData,
      saveAppData,
      renderSidebarNav,
      renderFooter,
      renderLoading,
      renderScreenHeader,
      showError,
      showFeedback,
      showConfirmationModal,
      getProductById,
      postApi,
      N8N_URLS,
      COLORS
    } from './app.js';

    // --- Estado da Página ---
    const pageState = {
      appData: null,
      products: []
    };

    // --- Funções Principais ---

    /**
     * Inicializa a página
     */
    function init() {
      // 1. Verifica autenticação
      if (!checkAuth()) return;

      // 2. Carrega dados do localStorage
      pageState.appData = getAppData();
      if (!pageState.appData) {
        showError("Falha ao carregar dados. Tente fazer login novamente.");
        return;
      }
      
      // 3. Pega os produtos
      pageState.products = [...pageState.appData.products].sort((a, b) => 
        a.property_nome.localeCompare(b.property_nome)
      );

      // 4. Renderiza componentes estáticos
      renderSidebarNav('produtos'); // Marca 'Produtos' como ativo
      renderFooter();
      renderScreenHeader("Produtos", "Consulte todos os produtos cadastrados.");
      
      // 5. Renderiza a lista de produtos
      renderProdutosTable();
    }
    
    /**
     * Renderiza a tabela de produtos
     */
    function renderProdutosTable() {
      const container = document.getElementById('products-list-container');
      if (!container) return;
      
      renderLoading(container, "A carregar produtos...");
      
      const { products } = pageState;

      // Simula um pequeno atraso para o spinner ser visível
      setTimeout(() => {
        if (products.length === 0) {
          container.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow border text-center text-gray-500">
              Nenhum produto encontrado.
            </div>
          `;
          return;
        }

        // Constrói as Linhas da Tabela
        const tableRows = products.map(product => {
          const status = product.property_situa_o_do_produto || 'Indefinido';
          const statusBadge = status === 'Ativo'
            ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">${status}</span>`
            : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">${status}</span>`;
            
          const categoria = (product.property_categoria && product.property_categoria[0]) || 'N/A';
          const unidade = product.property_unidade_de_medida || 'N/A';

          return `
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <a 
                  href="estoque_detalhe.html?id=${product.id}" 
                  class="text-sm font-medium hover:underline"
                  style="color: ${COLORS.blue};"
                  title="Ver histórico e detalhes"
                >
                  ${product.property_nome}
                </a>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${categoria}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${unidade}</td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                <a 
                  href="estoque_detalhe.html?id=${product.id}" 
                  class="px-3 py-1 rounded-md bg-gray-200 text-gray-700 transition-colors hover:bg-gray-300"
                  title="Ver Histórico"
                >
                  Histórico
                </a>
                <button 
                  class="cotar-btn px-3 py-1 rounded-md text-white transition-colors"
                  style="background-color: ${COLORS.orange};"
                  data-product-id="${product.id}"
                  title="Criar nova cotação"
                >
                  Cotar
                </button>
              </td>
            </tr>
          `;
        }).join('');
        
        // Renderiza a Tabela
        container.innerHTML = `
          <div class="bg-white shadow-md rounded-lg border border-gray-200 overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome do Produto</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Situação</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Un. Medida</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${tableRows}
              </tbody>
            </table>
          </div>
        `;
        
        // Adiciona listeners de eventos
        addEventListeners();
        
      }, 100);
    }
    
    /**
     * Adiciona os listeners de clique aos botões "Cotar"
     */
    function addEventListeners() {
      document.querySelectorAll('.cotar-btn').forEach(btn => {
        btn.addEventListener('click', handleCreateQuote);
      });
    }

    // --- Lógica de Ações ---

    /**
     * Manipula o clique no botão "Cotar"
     */
    async function handleCreateQuote(event) {
      const productId = event.target.dataset.productId;
      const { appData } = pageState;
      
      const product = getProductById(productId);
      if (!product) {
        showError("Produto não encontrado.");
        return;
      }
      
      // Encontra fornecedores únicos para este produto
      const fornecedorIds = appData.productSuppliers
        .filter(ps => ps.property_produto && ps.property_produto.includes(productId))
        .map(ps => ps.property_fornecedor[0])
        .filter((id, index, self) => self.indexOf(id) === index); // Filtra únicos

      // 1. Validação (RN-001)
      if (fornecedorIds.length === 0) {
        showError("Produto sem fornecedores cadastrados. Cotação não pode ser criada.");
        return;
      }
      
      // 2. Confirmação (RN-001)
      const messageHtml = `
        <p>Tem a certeza que quer gerar uma nova cotação para o produto <strong>${product.property_nome}</strong>?</p>
        <p class="text-sm text-gray-600">O estoque atual é de <strong>${product.property_estoque_atual}</strong>.</p>
        <p class="text-sm text-gray-600">A cotação será criada para <strong>${fornecedorIds.length}</strong> fornecedores.</p>
        
        <!-- Input de Quantidade (RN-002) -->
        <div class="mt-4">
          <label for="quote-quantity" class="block text-sm font-medium text-gray-700">
            Quantidade a Cotar (em ${product.property_unidade_de_medida})
          </label>
          <input 
            type="number" 
            id="quote-quantity" 
            value="1" 
            min="1" 
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2"
            style="focus:ring-color: ${COLORS.orange}; border-color: ${COLORS.azure};"
            required
          >
        </div>
      `;
      
      showConfirmationModal({
        title: "Confirmar Criação de Cotação",
        messageHtml: messageHtml,
        confirmText: "Confirmar e Criar",
        cancelText: "Cancelar",
        asyncAction: async () => {
          // Esta função é chamada quando o usuário clica em "Confirmar"
          
          const quantidadeInput = document.getElementById('quote-quantity');
          const quantidade = parseFloat(quantidadeInput.value);

          if (!quantidade || quantidade <= 0) {
            // Usa o throw para o modal mostrar o erro sem fechar
            throw new Error("A quantidade deve ser maior que zero.");
          }
          
          // 3. Gerar a Cotação e os Itens (RN-002)
          const newQuoteId = crypto.randomUUID();
          const nextQuoteNumber = (appData.quotes.length + 1).toString().padStart(3, '0');
          
          const newQuote = {
            id: newQuoteId,
            property_nome: `COT-${nextQuoteNumber}`,
            property_status: "Rascunho",
            property_produto: [productId],
            property_quantidade: quantidade, // Quantidade do input
            property_unidade_de_medida: [product.property_unidade_de_medida], // Unidade do produto
            property_item: [] // Será preenchido
          };

          const newItems = [];
          for (const [index, supplierId] of fornecedorIds.entries()) {
            const newItemId = crypto.randomUUID();
            const newItemNumber = (appData.quoteItems.length + index + 1).toString().padStart(3, '0');
            
            newItems.push({
              id: newItemId,
              property_nome: newItemNumber,
              property_status: "Criado",
              property_fornecedor: [supplierId],
              property_cota_o: [newQuoteId],
              property_preco: 0
            });
            
            newQuote.property_item.push(newItemId); // Adiciona ID do item à cotação
          }
          
          // 4. Construir Payload para o N8N
          const payload = {
            cotacao: {
              property_nome: newQuote.property_nome,
              property_status: newQuote.property_status,
              property_produto: newQuote.property_produto,
              property_quantidade: newQuote.property_quantidade,
              property_unidade_de_medida: newQuote.property_unidade_de_medida,
              id_local: newQuote.id // Envia ID local
            },
            itens: newItems.map(item => ({
              property_nome: item.property_nome,
              property_status: item.property_status,
              property_fornecedor: item.property_fornecedor,
              property_preco: item.property_preco,
              id_local: item.id // Envia ID local
            }))
          };
          
          try {
            // 5. Enviar para o N8N (o modal mostra o spinner)
            // TODO: Processar a resposta do N8N para atualizar os IDs locais com os IDs reais do Notion
            await postApi(N8N_URLS.createQuote, payload);
            
            // 6. Salvar localmente (se o N8N deu sucesso)
            const updatedData = getAppData(); // Pega os dados mais recentes
            updatedData.quotes.push(newQuote);
            updatedData.quoteItems.push(...newItems);
            saveAppData(updatedData);
            
            // 7. Redirecionar
            showFeedback("Cotação criada com sucesso!", "success");
            window.location.href = `cotacao_detalhe.html?id=${newQuoteId}`;
            
          } catch (n8nError) {
             // Se o postApi falhar, o modal (showConfirmationModal) vai apanhar o erro
             // e mostrá-lo ao usuário sem fechar.
             // Apenas registamos no console.
             console.error("Falha ao criar cotação no N8N:", n8nError);
             // Re-lança o erro para o modal o apanhar
             throw n8nError;
          }
        }
      });
    }

    // --- Inicialização ---
    init(); // Inicia a página

  </script>

</body>
</html>