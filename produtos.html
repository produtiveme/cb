<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produtos - Curral Burguer Gestão</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@10..48,700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #FFF9F3; }
    .font-heading { font-family: 'Bricolage Grotesque', sans-serif; }
    #main-content { flex: 1 1 auto; }
  </style>
</head>
<body>

  <div class="flex flex-col md:flex-row min-h-screen">
    <div id="sidebar-container"></div>
    <div class="flex-1 flex flex-col">
      <main id="main-content" class="flex-1 p-4 md:p-8 bg-gray-50"></main>
      <div id="footer-container"></div>
    </div>
  </div>
  <div id="error-container" class="fixed top-4 right-4 z-50"></div>

  <script type="module">
    import { 
      checkAuth, 
      renderSidebarNav, 
      renderFooter, 
      renderScreenHeader,
      renderLoading,
      showError,
      getAppData,
      saveAppData,
      COLORS
    } from './app.js';

    const mainContent = document.getElementById('main-content');
    let loading = false;

    const renderProdutosScreen = () => {
      const appData = getAppData();
      if (!appData) {
        showError("Falha ao carregar dados.");
        return;
      }
      
      const { products } = appData;

      mainContent.innerHTML = `
        ${renderScreenHeader('Produtos', 'Cadastro de todos os produtos.')}
        
        <div class="overflow-x-auto bg-white rounded-lg shadow">
          <table class="min-w-full divide-y divide-gray-200">
            <thead style="background-color: ${COLORS.azure};">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Produto</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Estoque Atual</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Unidade</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ações</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${products.map(product => `
                  <tr key="${product.id}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.property_nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${product.property_estoque_atual}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${product.property_unidade_de_medida || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                      <a 
                        href="estoque_detalhe.html?id=${product.id}"
                        class="inline-block px-3 py-1 rounded-md text-xs font-medium text-white"
                        style="background-color: ${COLORS.blue};"
                      >
                        Histórico
                      </a>
                      <button data-product-id="${product.id}" class="cotar-btn px-3 py-1 rounded-md text-xs font-medium text-white disabled:opacity-50"
                        style="background-color: ${COLORS.orange};" ${loading ? 'disabled' : ''}>
                        Cotar
                      </button>
                    </td>
                  </tr>
                `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      // Adiciona eventos
      document.querySelectorAll('.cotar-btn').forEach(btn => btn.addEventListener('click', handleCreateQuote));
    };

    // Handler para criar cotação (igual ao da tela de estoque)
    const handleCreateQuote = (e) => {
      loading = true;
      renderProdutosScreen(); // Re-renderiza para desabilitar botões
      
      const productId = e.currentTarget.dataset.productId;
      const appData = getAppData();
      const { products, productSuppliers, quotes, quoteItems } = appData;

      const product = products.find(p => p.id === productId);
      if (!product) {
        showError('Produto não encontrado.');
        loading = false;
        renderProdutosScreen();
        return;
      }

      const productSupplierIds = product.property_fornecedor_do_produto;
      const supplierIds = productSuppliers
        .filter(ps => productSupplierIds.includes(ps.id))
        .map(ps => ps.property_fornecedor[0]);
      const uniqueSupplierIds = [...new Set(supplierIds)];

      if (uniqueSupplierIds.length === 0) {
        showError('Produto sem fornecedores cadastrados.');
        loading = false;
        renderProdutosScreen();
        return;
      }
      
      const newQuoteId = `cot-id-${Math.random().toString(36).substr(2, 9)}`;
      const newQuoteName = `COT-${String(quotes.length + 1).padStart(3, '0')}`;
      const newQuote = {
        id: newQuoteId, name: newQuoteName, property_produto: [productId],
        property_quantidade: 1, property_unidade_de_medida: [product.property_unidade_de_medida],
        property_item: [], property_status: "Rascunho", property_nome: newQuoteName
      };
      
      const newItems = uniqueSupplierIds.map((supplierId, index) => {
        const newItemId = `item-id-${Math.random().toString(36).substr(2, 9)}`;
        newQuote.property_item.push(newItemId);
        return {
          id: newItemId, name: `${String(index + 1).padStart(3, '0')}`,
          property_status: "Criado", property_fornecedor: [supplierId],
          property_cota_o: [newQuoteId], property_produto: [productId],
          property_nome: `${String(index + 1).padStart(3, '0')}`, property_preco: null
        };
      });

      appData.quotes.push(newQuote);
      appData.quoteItems.push(...newItems);
      saveAppData(appData);
      
      window.location.href = `cotacao_detalhe.html?id=${newQuoteId}`;
    };

    // --- Inicialização ---
    document.addEventListener('DOMContentLoaded', () => {
      if (checkAuth()) {
        renderSidebarNav('produtos');
        renderFooter();
        renderLoading(mainContent, 'Carregando produtos...');
        setTimeout(renderProdutosScreen, 100); 
      }
    });
  </script>
</body>
</html>