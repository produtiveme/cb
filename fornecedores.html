<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fornecedores - Gest√£o de Cota√ß√£o</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Estilo Global Centralizado -->
  <link rel="stylesheet" href="style.css">

</head>

<body>

  <div class="flex flex-col md:flex-row min-h-screen">

    <!-- Sidebar (ser√° preenchida pelo app.js) -->
    <div id="sidebar-container"></div>

    <!-- Conte√∫do Principal -->
    <main class="flex-1 p-6 md:p-10">

      <!-- Cabe√ßalho (ser√° preenchido pelo app.js) -->
      <header id="header-container"></header>

      <!-- Container para Alertas -->
      <div id="error-container" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>

      <!-- Container do Modal (inicialmente oculto) -->
      <div id="modal-container" class="hidden"></div>

      <!-- Conte√∫do da P√°gina (ser√° preenchido pelo JS) -->
      <div id="suppliers-list-container">
        <!-- O Spinner de carregamento ou a lista de fornecedores ser√£o injetados aqui -->
      </div>

    </main>
  </div>

  <!-- Rodap√© (ser√° preenchido pelo app.js) -->
  <div id="footer-container"></div>


  <!-- Script da P√°gina -->
  <script type="module">
    import {
      checkAuth,
      getAppData,
      saveAppData,
      renderSidebarNav,
      renderFooter,
      renderLoading,
      renderScreenHeader,
      showError,
      showFeedback,
      showConfirmationModal,
      getItemById,
      getQuoteById,
      getProductName,
      COLORS
    } from './app.js';

    // --- Estado da P√°gina ---
    const pageState = {
      appData: null,
      suppliers: []
    };

    // --- Fun√ß√µes Principais ---

    /**
     * Inicializa a p√°gina
     */
    function init() {
      // 1. Verifica autentica√ß√£o
      if (!checkAuth()) return;

      // 2. Carrega dados do localStorage
      pageState.appData = getAppData();
      if (!pageState.appData) {
        showError("Falha ao carregar dados. Tente fazer login novamente.");
        return;
      }

      // 3. Pega os fornecedores
      pageState.suppliers = [...pageState.appData.suppliers].sort((a, b) =>
        a.property_nome.localeCompare(b.property_nome)
      );

      // 4. Renderiza componentes est√°ticos
      renderSidebarNav('fornecedores'); // Marca 'Fornecedores' como ativo
      renderFooter();
      renderScreenHeader("Fornecedores", "Consulte os fornecedores cadastrados e envie cota√ß√µes pendentes.");

      // 5. Renderiza a lista de fornecedores
      renderSuppliersTable();
    }

    /**
     * Obt√©m itens pendentes (Status 'Criado') para um fornecedor
     */
    function getPendingItemsForSupplier(supplierId) {
      const { appData } = pageState;
      if (!appData.quoteItems) return [];

      return appData.quoteItems.filter(item =>
        item.property_fornecedor &&
        item.property_fornecedor.includes(supplierId) &&
        item.property_status === 'Criado'
      );
    }

    /**
     * Renderiza a tabela de fornecedores
     */
    function renderSuppliersTable() {
      const container = document.getElementById('suppliers-list-container');
      if (!container) return;

      renderLoading(container, "A carregar fornecedores...");

      const { suppliers } = pageState;

      // Simula um pequeno atraso para o spinner ser vis√≠vel
      setTimeout(() => {
        if (suppliers.length === 0) {
          container.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow border text-center text-gray-500">
              Nenhum fornecedor encontrado.
            </div>
          `;
          return;
        }

        // Constr√≥i as Linhas da Tabela
        const tableRows = suppliers.map(supplier => {
          // Contagem de produtos vinculados
          const productCount = (pageState.appData.productSuppliers || [])
            .filter(ps => ps.property_fornecedor && ps.property_fornecedor.includes(supplier.id))
            .length;

          // Itens pendentes para envio
          const pendingItems = getPendingItemsForSupplier(supplier.id);
          const hasPending = pendingItems.length > 0;

          return `
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${supplier.property_nome}</div>
                ${hasPending ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 mt-1">${pendingItems.length} pendente(s)</span>` : ''}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${productCount} produtos vinculados</td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                ${hasPending ? `
                  <button 
                    class="batch-send-btn px-3 py-1 rounded-md text-white transition-colors hover:opacity-90"
                    style="background-color: #25D366;"
                    data-supplier-id="${supplier.id}"
                    title="Enviar ${pendingItems.length} itens pendentes via WhatsApp"
                  >
                    Enviar Pend√™ncias (${pendingItems.length})
                  </button>
                ` : ''}
                <a 
                  href="${supplier.url}" 
                  target="_blank" 
                  class="px-3 py-1 rounded-md bg-gray-200 text-gray-700 transition-colors hover:bg-gray-300 inline-block"
                  title="Abrir no Notion"
                >
                  Abrir no Notion
                </a>
              </td>
            </tr>
          `;
        }).join('');

        // Renderiza a Tabela
        container.innerHTML = `
          <div class="bg-white shadow-md rounded-lg border border-gray-200 overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome do Fornecedor</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">V√≠nculos</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${tableRows}
              </tbody>
            </table>
          </div>
        `;

        // Adiciona Listeners
        document.querySelectorAll('.batch-send-btn').forEach(btn => {
          btn.addEventListener('click', handleBatchSend);
        });

      }, 100);
    }

    /**
     * Lida com o envio em massa
     */
    function handleBatchSend(event) {
      const supplierId = event.currentTarget.dataset.supplierId;
      const supplier = pageState.suppliers.find(s => s.id === supplierId);

      if (!supplier) {
        showError("Fornecedor n√£o encontrado.");
        return;
      }

      const pendingItems = getPendingItemsForSupplier(supplierId);
      if (pendingItems.length === 0) {
        showError("N√£o h√° itens pendentes para este fornecedor.");
        return;
      }

      // 1. Verifica telefone
      const phone = supplier.property_whats_app;
      if (!phone) {
        showError(`Fornecedor ${supplier.property_nome} n√£o possui WhatsApp cadastrado.`);
        return;
      }
      const cleanPhone = phone.replace(/[\s\+\-\(\)]/g, '');

      // 2. Agrupa itens por Cota√ß√£o
      const itemsByQuote = {};
      pendingItems.forEach(item => {
        // Tenta encontrar a propriedade correta (pode variar dependendo do N8N)
        const quoteIdList = item.property_cota_o || item.property_cotacao;
        const quoteId = (quoteIdList && quoteIdList.length > 0) ? quoteIdList[0] : 'unknown';

        if (!itemsByQuote[quoteId]) {
          itemsByQuote[quoteId] = [];
        }
        itemsByQuote[quoteId].push(item);
      });

      // 3. Gera a mensagem
      let text = `Ol√°, ${supplier.property_nome}!\n`;
      text += `Gostaria de solicitar cota√ß√£o para:\n\n`;

      Object.keys(itemsByQuote).forEach(quoteId => {
        const quote = getQuoteById(quoteId);
        const quoteName = quote ? quote.property_nome : '(Cota√ß√£o sem ref)';

        itemsByQuote[quoteId].forEach(item => {
          let itemDescription = '';

          if (quote) {
            const productName = getProductName(quote.property_produto[0]);
            const quantidade = quote.property_quantidade || '?';
            const unidade = (quote.property_unidade_de_medida && quote.property_unidade_de_medida[0]) || '';

            // Novo Formato:
            // üì¶ *Produto*
            // Qtd: 10 Unidade
            // (Ref: COT-001)
            itemDescription = `üì¶ *${productName}*\nQtd: ${quantidade} ${unidade}\n(Ref: ${quoteName})`;
          } else {
            // Se n√£o achou a cota√ß√£o, tenta mostrar algo √∫til do item se poss√≠vel
            console.warn('Item sem cota√ß√£o pai encontrada:', item);
          }

          text += `- ${itemDescription}\n`;
        });
        text += `\n`;
      });

      text += `Aguardo retorno. Obrigado!`;

      // 4. Abre WhatsApp
      const encodedText = encodeURIComponent(text);
      const url = `https://wa.me/${cleanPhone}?text=${encodedText}`;
      window.open(url, '_blank');

      // 5. Pergunta se deseja marcar como enviado
      showConfirmationModal({
        title: "Confirmar Envio",
        messageHtml: `
          <p>Voc√™ enviou ${pendingItems.length} itens para o WhatsApp de <strong>${supplier.property_nome}</strong>.</p>
          <p class="mt-2 text-sm text-gray-600">Deseja marcar esses itens como <strong>"Enviado"</strong> no sistema?</p>
        `,
        confirmText: "Sim, marcar como Enviado",
        cancelText: "N√£o, manter como Criado",
        asyncAction: async () => {
          // Atualiza status localmente
          const { appData } = pageState;
          let updatedCount = 0;

          pendingItems.forEach(pendingItem => {
            const itemIndex = appData.quoteItems.findIndex(i => i.id === pendingItem.id);
            if (itemIndex !== -1) {
              appData.quoteItems[itemIndex].property_status = 'Enviado Fornecedor'; // Atualizado para o status correto do Notion
              updatedCount++;
            }
          });

          saveAppData(appData);
          showFeedback(`${updatedCount} itens marcados como Enviado!`, 'success');

          // Re-renderiza a tabela
          renderSuppliersTable();
        }
      });
    }

    // --- Inicializa√ß√£o ---
    init(); // Inicia a p√°gina

  </script>

</body>

</html>