<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fornecedores - Gestão de Cotação</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Estilo Global Centralizado -->
  <link rel="stylesheet" href="style.css">

</head>
<body>

  <div class="flex flex-col md:flex-row min-h-screen">
    
    <!-- Sidebar (será preenchida pelo app.js) -->
    <div id="sidebar-container"></div>

    <!-- Conteúdo Principal -->
    <main class="flex-1 p-6 md:p-10">

      <!-- Cabeçalho (será preenchido pelo app.js) -->
      <header id="header-container"></header>

      <!-- Container para Alertas -->
      <div id="error-container" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>
      
      <!-- Container do Modal (inicialmente oculto) -->
      <div id="modal-container" class="hidden"></div>

      <!-- Conteúdo da Página (será preenchido pelo JS) -->
      <div id="suppliers-list-container">
        <!-- O Spinner de carregamento ou a lista de fornecedores serão injetados aqui -->
      </div>
      
    </main>
  </div>

  <!-- Rodapé (será preenchido pelo app.js) -->
  <div id="footer-container"></div>


  <!-- Script da Página -->
  <script type="module">
    import {
      checkAuth,
      getAppData,
      renderSidebarNav,
      renderFooter,
      renderLoading,
      renderScreenHeader,
      showError,
      COLORS
    } from './app.js';

    // --- Estado da Página ---
    const pageState = {
      appData: null,
      suppliers: []
    };

    // --- Funções Principais ---

    /**
     * Inicializa a página
     */
    function init() {
      // 1. Verifica autenticação
      if (!checkAuth()) return;

      // 2. Carrega dados do localStorage
      pageState.appData = getAppData();
      if (!pageState.appData) {
        showError("Falha ao carregar dados. Tente fazer login novamente.");
        return;
      }
      
      // 3. Pega os fornecedores
      pageState.suppliers = [...pageState.appData.suppliers].sort((a, b) => 
        a.property_nome.localeCompare(b.property_nome)
      );

      // 4. Renderiza componentes estáticos
      renderSidebarNav('fornecedores'); // Marca 'Fornecedores' como ativo
      renderFooter();
      renderScreenHeader("Fornecedores", "Consulte os fornecedores cadastrados.");
      
      // 5. Renderiza a lista de fornecedores
      renderSuppliersTable();
    }
    
    /**
     * Renderiza a tabela de fornecedores
     */
    function renderSuppliersTable() {
      const container = document.getElementById('suppliers-list-container');
      if (!container) return;
      
      renderLoading(container, "A carregar fornecedores...");
      
      const { suppliers } = pageState;

      // Simula um pequeno atraso para o spinner ser visível
      setTimeout(() => {
        if (suppliers.length === 0) {
          container.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow border text-center text-gray-500">
              Nenhum fornecedor encontrado.
            </div>
          `;
          return;
        }

        // Constrói as Linhas da Tabela
        const tableRows = suppliers.map(supplier => {
          // Contagem de produtos vinculados
          const productCount = (pageState.appData.productSuppliers || [])
            .filter(ps => ps.property_fornecedor && ps.property_fornecedor.includes(supplier.id))
            .length;

          return `
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${supplier.property_nome}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${productCount} produtos vinculados</td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <a 
                  href="${supplier.url}" 
                  target="_blank" 
                  class="px-3 py-1 rounded-md bg-gray-200 text-gray-700 transition-colors hover:bg-gray-300"
                  title="Abrir no Notion"
                >
                  Abrir no Notion
                </a>
              </td>
            </tr>
          `;
        }).join('');
        
        // Renderiza a Tabela
        container.innerHTML = `
          <div class="bg-white shadow-md rounded-lg border border-gray-200 overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome do Fornecedor</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vínculos</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${tableRows}
              </tbody>
            </table>
          </div>
        `;
        
      }, 100);
    }

    // --- Inicialização ---
    init(); // Inicia a página

  </script>

</body>
</html>