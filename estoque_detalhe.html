<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhe do Estoque - Curral Burguer Gestão</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@10..48,700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #FFF9F3; }
    .font-heading { font-family: 'Bricolage Grotesque', sans-serif; }
    #main-content { flex: 1 1 auto; }
  </style>
</head>
<body>

  <div class="flex flex-col md:flex-row min-h-screen">
    <div id="sidebar-container"></div>
    
    <div class="flex-1 flex flex-col">
      <main id="main-content" class="flex-1 p-4 md:p-8 bg-gray-50"></main>
      <div id="footer-container"></div>
    </div>
  </div>
  
  <div id="error-container" class="fixed top-4 right-4 z-50"></div>

  <script type="module">
    import { 
      checkAuth, 
      renderSidebarNav, 
      renderFooter, 
      renderScreenHeader,
      renderLoading,
      showError,
      getAppData,
      formatDate,
      COLORS
    } from './app.js';

    const mainContent = document.getElementById('main-content');
    let myStockChart = null; // Guarda a instância do gráfico

    // Função para inicializar o gráfico de linha
    const initStockChart = (productId, appData) => {
      const { products, stockHistory } = appData;
      const product = products.find(p => p.id === productId);
      if (!product) return;

      const ctx = document.getElementById('stock-line-chart');
      if (!ctx) return; 

      // 1. Pega o histórico e ordena do mais antigo para o mais novo
      const history = stockHistory
        .filter(item => item.property_produto && item.property_produto.includes(productId))
        .sort((a, b) => new Date(a.property_criado_em) - new Date(b.property_criado_em));

      // 2. Calcula o estoque inicial
      const estoqueAtual = product.property_estoque_atual;
      const totalEntradas = history.reduce((acc, item) => 
        item.property_movimento === 'Entrada' ? acc + item.property_quantidade : acc, 0);
      const totalSaidas = history.reduce((acc, item) => 
        item.property_movimento === 'Saída' ? acc + item.property_quantidade : acc, 0);
      
      // Estoque Inicial = Estoque Atual - (Total de Entradas) + (Total de Saídas)
      const estoqueInicial = estoqueAtual - totalEntradas + totalSaidas;

      // 3. Prepara os dados para o gráfico
      const labels = ['Estoque Inicial'];
      const data = [estoqueInicial];
      let currentStock = estoqueInicial;

      history.forEach(item => {
        if (item.property_movimento === 'Entrada') {
          currentStock += item.property_quantidade;
        } else { // Saída
          currentStock -= item.property_quantidade;
        }
        labels.push(formatDate(item.property_criado_em));
        data.push(currentStock);
      });
      
      // 4. Destrói gráfico anterior, se houver
      if (myStockChart) {
        myStockChart.destroy();
      }

      // 5. Cria o gráfico
      myStockChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade em Estoque',
            data: data,
            borderColor: COLORS.orange,
            backgroundColor: 'rgba(255, 78, 0, 0.1)',
            fill: true,
            tension: 0.1,
            pointBackgroundColor: COLORS.orange,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: { y: { beginAtZero: true } },
          plugins: {
            tooltip: {
              callbacks: {
                title: (tooltipItems) => `Data: ${tooltipItems[0].label}`,
                label: (tooltipItem) => `Estoque: ${tooltipItem.raw}`
              }
            }
          }
        }
      });
    };
    
    // ** NOVO: Helper para renderizar o "Badge" de Status **
    const renderStatusBadge = (status) => {
      let bgColor, textColor;
      switch (status) {
        case 'Ativo':
          bgColor = 'bg-green-100';
          textColor = 'text-green-800';
          break;
        case 'Inativo':
          bgColor = 'bg-red-100';
          textColor = 'text-red-800';
          break;
        default:
          bgColor = 'bg-gray-100';
          textColor = 'text-gray-800';
      }
      return `
        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${bgColor} ${textColor}">
          ${status}
        </span>
      `;
    };

    // Renderiza a tela de detalhe
    const renderEstoqueDetailScreen = (productId) => {
      const appData = getAppData();
      if (!appData) {
        showError("Falha ao carregar dados.");
        return;
      }
      
      const { products, stockHistory } = appData;
      const product = products.find(p => p.id === productId);

      if (!product) {
        showError("Produto não encontrado.");
        window.location.href = 'estoque.html';
        return;
      }
      
      const history = stockHistory
        .filter(item => item.property_produto && item.property_produto.includes(productId))
        .sort((a, b) => new Date(b.property_criado_em) - new Date(a.property_criado_em)); // Ordena do mais novo para o mais antigo

      // ** MODIFICADO: Adiciona o botão "Abrir no Notion" **
      const buttonsHtml = `
        <div class="flex flex-wrap gap-2">
          <a href="estoque.html"
            class="px-4 py-2 rounded-md text-sm font-medium bg-gray-200 hover:bg-gray-300"
          >
            &larr; Voltar para Estoque
          </a>
          <a href="${product.url}" target="_blank" rel="noopener noreferrer"
            class="px-4 py-2 rounded-md text-sm font-medium text-white hover:opacity-90"
            style="background-color: ${COLORS.black};"
            title="Abrir este produto no Notion em uma nova aba"
          >
            Abrir no Notion
          </a>
        </div>
      `;

      // Prepara os dados novos
      const descricao = product.property_descri_o_do_produto || 'Nenhuma descrição fornecida.';
      const situacao = product.property_situa_o_do_produto || 'Indefinida';
      // Converte o array de categoria em string
      const categoria = product.property_categoria && product.property_categoria.length > 0 
        ? product.property_categoria.join(', ') 
        : 'Sem categoria';
      const unidade = product.property_unidade_de_medida || 'N/A';
      
      mainContent.innerHTML = `
        ${renderScreenHeader(`Histórico: ${product.property_nome}`, `Estoque Atual: ${product.property_estoque_atual} | Mínimo: ${product.property_estoque_m_nimo}`, buttonsHtml)}

        <div class="space-y-6">
          
          <!-- CARD: Detalhes do Produto -->
          <div class="p-4 bg-white rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-4 font-heading" style="color: ${COLORS.black};">Detalhes do Produto</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <!-- Descrição (ocupando mais espaço) -->
              <div class="md:col-span-2">
                <dt class="text-sm font-medium text-gray-500">Descrição</dt>
                <dd class="mt-1 text-sm text-gray-900">${descricao}</dd>
              </div>
              <!-- Situação -->
              <div>
                <dt class="text-sm font-medium text-gray-500">Situação</dt>
                <dd class="mt-1 text-sm text-gray-900">${renderStatusBadge(situacao)}</dd>
              </div>
              <!-- Categoria -->
              <div>
                <dt class="text-sm font-medium text-gray-500">Categoria</dt>
                <dd class="mt-1 text-sm text-gray-900">${categoria}</dd>
              </div>
              <!-- Unidade de Medida -->
              <div>
                <dt class="text-sm font-medium text-gray-500">Un. de Medida</dt>
                <dd class="mt-1 text-sm text-gray-900">${unidade}</dd>
              </div>
            </div>
          </div>
          
          <!-- Card do Gráfico (existente) -->
          <div class="p-4 bg-white rounded-lg shadow">
            <h3 class="text-lg font-semibold mb-4 font-heading" style="color: ${COLORS.black};">Evolução do Estoque</h3>
            <canvas id="stock-line-chart"></canvas>
          </div>

          <!-- Tabela (existente) -->
          <div class="overflow-x-auto bg-white rounded-lg shadow">
            <h3 class="text-lg font-semibold p-4 font-heading" style="color: ${COLORS.black};">Histórico de Movimentação</h3>
            <table class="min-w-full divide-y divide-gray-200">
              <thead style="background-color: ${COLORS.azure};">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Data</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Movimento</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Quantidade</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                ${history.length > 0 ? history.map(item => {
                  const isEntrada = item.property_movimento === 'Entrada';
                  return `
                    <tr key="${item.id}">
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(item.property_criado_em)}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${isEntrada ? 'text-green-600' : 'text-red-600'}">
                        ${item.property_movimento}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${isEntrada ? 'text-green-600' : 'text-red-600'}">
                        ${isEntrada ? '+' : '-'} ${item.property_quantidade}
                      </td>
                    </tr>
                  `;
                }).join('') : `
                  <tr>
                    <td colspan="3" class="px-6 py-4 text-center text-gray-500">Nenhum histórico de movimentação encontrado.</td>
                  </tr>
                `}
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      // Inicializa o gráfico
      initStockChart(productId, appData);
    };

    // --- Inicialização ---
    document.addEventListener('DOMContentLoaded', () => {
      if (checkAuth()) {
        renderSidebarNav('estoque');
        renderFooter();
        renderLoading(mainContent, 'Carregando detalhes do produto...');
        
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id');

        if (productId) {
          // Usamos um pequeno timeout para garantir que os dados do localStorage estejam prontos (embora devam estar)
          setTimeout(() => renderEstoqueDetailScreen(productId), 100);
        } else {
          showError('ID do produto não fornecido.');
          window.location.href = 'estoque.html';
        }
      }
    });
  </script>
</body>
</html>