<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhe do Estoque - Curral Burguer Gestão</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@10..48,700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #FFF9F3; }
    .font-heading { font-family: 'Bricolage Grotesque', sans-serif; }
    #main-content { flex: 1 1 auto; }
  </style>
</head>
<body>

  <div class="flex flex-col md:flex-row min-h-screen">
    <div id="sidebar-container"></div>
    <div class="flex-1 flex flex-col">
      <main id="main-content" class="flex-1 p-4 md:p-8 bg-gray-50"></main>
      <div id="footer-container"></div>
    </div>
  </div>
  <div id="error-container" class="fixed top-4 right-4 z-50"></div>

  <script type="module">
    import { 
      checkAuth, 
      renderSidebarNav, 
      renderFooter, 
      renderScreenHeader,
      renderLoading,
      showError,
      getAppData,
      formatDate,
      COLORS
    } from './app.js';

    const mainContent = document.getElementById('main-content');
    let stockChart = null; // Guarda a instância do gráfico

    // Renderiza um selo (badge) para o status do produto
    const renderStatusBadge = (status) => {
      const isActive = status === 'Ativo';
      const bgColor = isActive ? 'bg-green-100' : 'bg-gray-100';
      const textColor = isActive ? 'text-green-800' : 'text-gray-800';
      return `<span class="px-2 py-0.5 text-xs font-medium rounded-full ${bgColor} ${textColor}">${status}</span>`;
    };

    // Renderiza a tela principal
    const renderEstoqueDetailScreen = (productId) => {
      const appData = getAppData();
      if (!appData) {
        showError("Falha ao carregar dados.");
        return;
      }

      const { products, stockHistory } = appData;
      const product = products.find(p => p.id === productId);

      if (!product) {
        showError("Produto não encontrado.");
        window.location.href = 'estoque.html';
        return;
      }

      const history = stockHistory
        .filter(item => item.property_produto.includes(productId))
        .sort((a, b) => new Date(a.property_criado_em) - new Date(b.property_criado_em)); // Ordena do mais antigo ao mais novo

      // Botões do Cabeçalho
      const buttonsHtml = `
        <div class="flex gap-2">
          <a href="estoque.html"
            class="px-4 py-2 rounded-md text-sm font-medium bg-gray-200 hover:bg-gray-300"
          >
            &larr; Voltar para Estoque
          </a>
          <a href="${product.url}"
            target="_blank"
            rel="noopener noreferrer"
            class="px-4 py-2 rounded-md text-sm font-medium text-white flex items-center"
            style="background-color: ${COLORS.orange};"
          >
            <!-- Ícone Notion (simplificado) -->
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M16 17v-4a2 2 0 00-2-2h-4a2 2 0 00-2 2v4"></path></svg>
            Abrir no Notion
          </a>
        </div>
      `;
      
      mainContent.innerHTML = `
        ${renderScreenHeader(`Histórico: ${product.property_nome}`, `Estoque Atual: ${product.property_estoque_atual}`, buttonsHtml)}
        
        <!-- Card de Detalhes do Produto -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
          <h3 class="text-lg font-bold font-heading mb-3" style="color: ${COLORS.black};">Detalhes do Produto</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-500">Descrição</label>
              <p class="text-gray-900 font-medium">${product.property_descri_o_do_produto || 'N/D'}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500">Situação</label>
              <p class="text-gray-900 font-medium">${renderStatusBadge(product.property_situa_o_do_produto || 'N/D')}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500">Categoria</label>
              <p class="text-gray-900 font-medium">${product.property_categoria[0] || 'N/D'}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500">Un. de Medida</label>
              <p class="text-gray-900 font-medium">${product.property_unidade_de_medida || 'N/D'}</p>
            </div>
          </div>
        </div>

        <!-- Card do Gráfico -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
          <h3 class="text-lg font-bold font-heading mb-3" style="color: ${COLORS.black};">Evolução do Estoque</h3>
          <canvas id="stockChartCanvas"></canvas>
        </div>

        <!-- Card da Tabela de Histórico -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
          <h3 class="text-lg font-bold font-heading p-4" style="color: ${COLORS.black};">Histórico de Movimentação</h3>
          <table class="min-w-full divide-y divide-gray-200">
            <thead style="background-color: ${COLORS.azure};">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Data</th>
                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Movimento</th>
                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Quantidade</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${history.length === 0 ? `
                <tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Nenhuma movimentação encontrada.</td></tr>
              ` : 
                history.map(item => `
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatDate(item.property_criado_em)}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${item.property_movimento === 'Entrada' ? 'text-green-600' : 'text-red-600'}">
                    ${item.property_movimento}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.property_quantidade}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      // Inicializa o gráfico
      initStockChart(product, history);
    };
    
    // Inicializa o gráfico de estoque
    const initStockChart = (product, history) => {
      const ctx = document.getElementById('stockChartCanvas');
      if (!ctx) return;

      // Destrói gráfico antigo se existir
      if (stockChart) {
        stockChart.destroy();
      }

      // Calcula o estado do estoque ao longo do tempo
      const labels = [];
      const dataPoints = [];
      
      // 1. Calcular o estoque inicial (antes do primeiro registro)
      let currentStock = product.property_estoque_atual;
      // Subtrai entradas e soma saídas para encontrar o ponto de partida
      for (let i = history.length - 1; i >= 0; i--) {
        const item = history[i];
        if (item.property_movimento === 'Entrada') {
          currentStock -= item.property_quantidade;
        } else {
          currentStock += item.property_quantidade;
        }
      }

      // 2. Adiciona o ponto de partida (antes da primeira movimentação)
      if (history.length > 0) {
        const firstDate = new Date(history[0].property_criado_em);
        firstDate.setDate(firstDate.getDate() - 1); // Um dia antes
        labels.push(formatDate(firstDate.toISOString()));
        dataPoints.push(currentStock);
      } else {
         // Se não há histórico, mostra apenas o estoque atual
         labels.push(formatDate(new Date().toISOString()));
         dataPoints.push(currentStock);
         return; // Gráfico não é muito útil, mas os dados estão lá
      }

      // 3. Processa o histórico cronologicamente
      history.forEach(item => {
        if (item.property_movimento === 'Entrada') {
          currentStock += item.property_quantidade;
        } else {
          currentStock -= item.property_quantidade;
        }
        labels.push(formatDate(item.property_criado_em));
        dataPoints.push(currentStock);
      });

      // 4. Renderiza o gráfico
      stockChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade em Estoque',
            data: dataPoints,
            borderColor: COLORS.orange,
            backgroundColor: 'rgba(255, 78, 0, 0.1)',
            fill: true,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    };

    // --- Inicialização da Página ---
    document.addEventListener('DOMContentLoaded', () => {
      if (checkAuth()) {
        renderSidebarNav('estoque'); // <-- CORRIGIDO
        renderFooter();
        renderLoading(mainContent, 'Carregando detalhes do produto...');
        
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id'); // <-- CORRIGIDO

        if (productId) {
          setTimeout(() => renderEstoqueDetailScreen(productId), 100); // <-- CORRIGIDO
        } else {
          showError('ID do produto não fornecido.');
          window.location.href = 'estoque.html'; // <-- CORRIGIDO
        }
      }
    });
  </script>
</body>
</html>